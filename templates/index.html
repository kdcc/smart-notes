<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知行 - 本地化读书笔记智能助手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Markdown渲染支持 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <!-- 代码高亮支持 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/highlight.min.js"></script>
    <!-- html2canvas for screenshot sharing -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- Three.js for 3D visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1200px;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 2rem;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .chat-container {
            height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .message {
            margin-bottom: 20px;
        }
        
        .user-message {
            text-align: right;
        }
        
        .user-message .message-bubble {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 18px;
            border-radius: 18px 18px 5px 18px;
            display: inline-block;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .bot-message .message-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 15px 20px;
            border-radius: 18px 18px 18px 5px;
            display: inline-block;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .sources-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9em;
        }
        
        .confidence-badge {
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        .input-group {
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-control {
            border: none;
            padding: 15px 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            padding: 15px 25px;
        }
        
        .btn-outline-secondary {
            border-radius: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: #007bff;
        }
        
        .test-result {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .thinking-process {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #495057;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .thinking-process.show {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        .thinking-toggle {
            font-size: 0.8em;
            margin-top: 5px;
            cursor: pointer;
        }
        
        .thinking-toggle-container {
            text-align: center;
            padding: 10px 0;
        }
        
        .thinking-toggle-container .btn {
            font-size: 0.85em;
            padding: 5px 12px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .thinking-toggle-container .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .streaming-status {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 0 6px 6px 0;
            font-size: 0.85em;
            color: #1976d2;
            animation: pulse 1.5s infinite;
            transition: all 0.3s ease;
        }
        
        .streaming-status.completed {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #388e3c;
            animation: none;
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .step-indicator.completed {
            color: #388e3c;
        }
        
        .typing-effect {
            border-right: 2px solid #007bff;
            animation: blink 1s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        @keyframes blink {
            0%, 50% { border-color: #007bff; }
            51%, 100% { border-color: transparent; }
        }
        
        .markdown-content {
            line-height: 1.6;
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3,
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }
        
        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.4em; }
        .markdown-content h3 { font-size: 1.3em; }
        .markdown-content h4 { font-size: 1.2em; }
        .markdown-content h5 { font-size: 1.1em; }
        .markdown-content h6 { font-size: 1.0em; }
        
        .markdown-content p {
            margin-bottom: 1em;
            line-height: 1.7;
        }
        
        .markdown-content ul, .markdown-content ol {
            padding-left: 1.8em;
            margin-bottom: 1.5em;
            margin-top: 0.5em;
        }
        
        .markdown-content li {
            margin-bottom: 0.6em;
            line-height: 1.8;
            padding-bottom: 0.3em;
        }
        
        .markdown-content li ul, .markdown-content li ol {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        
        /* 确保列表项有足够的视觉分隔 */
        .markdown-content li p {
            margin-bottom: 0.5em;
        }
        
        /* 数字列表样式 */
        .markdown-content ol li {
            margin-bottom: 0.8em;
            padding-left: 0.3em;
        }
        
        /* 无序列表样式 */
        .markdown-content ul li {
            margin-bottom: 0.8em;
            padding-left: 0.3em;
        }
        
        /* 强制列表项显示 */
        .markdown-content ul li::marker {
            content: "• ";
            color: #007bff;
            font-weight: bold;
        }
        
        .markdown-content ol li::marker {
            color: #007bff;
            font-weight: bold;
        }
        
        /* 确保破折号列表正确显示 */
        .markdown-content ul li:has-text("- ") {
            list-style-type: none;
        }
        
        /* 确保每个列表项都有足够的空间 */
        .markdown-content li:not(:last-child) {
            border-bottom: 1px solid transparent;
            padding-bottom: 0.5em;
        }
        
        /* 强制列表项显示，确保markdown列表正确渲染 */
        .markdown-content ul {
            list-style-type: disc;
            padding-left: 2em;
        }
        
        .markdown-content ol {
            list-style-type: decimal;
            padding-left: 2em;
        }
        
        /* 确保列表项内容正确换行 */
        .markdown-content li {
            display: list-item;
            margin-bottom: 0.5em;
        }
        
        /* 处理以破折号开头的列表项 */
        .markdown-content ul li:first-line {
            display: block;
        }
        
        /* 确保列表项内的段落有正确的间距 */
        .markdown-content li p {
            margin-bottom: 0.5em;
            margin-top: 0.5em;
        }
        
        /* 强制保持数字列表的原始数字 */
        .markdown-content ol {
            counter-reset: none;
        }
        
        .markdown-content ol li {
            counter-increment: none;
        }
        
        .markdown-content ol li::marker {
            content: attr(data-number) ". ";
        }
        
        .markdown-content p {
            margin-bottom: 1em;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #007bff;
            padding-left: 1em;
            margin: 1em 0;
            color: #6c757d;
            font-style: italic;
        }
        
        .markdown-content code {
            background: #f8f9fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .markdown-content pre {
            background: #f8f9fa;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }
        
        .share-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .share-button:hover {
            background: linear-gradient(135deg, #218838, #1ba885);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        .share-preview {
            background: white;
            border: 2px solid #007bff;
            border-radius: 12px;
            padding: 24px;
            margin: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            position: relative;
        }
        
        /* 分享预览中的markdown内容样式 */
        .share-preview .markdown-content {
            line-height: 1.6;
        }
        
        .share-preview .markdown-content h1, .share-preview .markdown-content h2, .share-preview .markdown-content h3,
        .share-preview .markdown-content h4, .share-preview .markdown-content h5, .share-preview .markdown-content h6 {
            color: #333;
            margin: 1em 0 0.5em 0;
            font-weight: 600;
        }
        
        .share-preview .markdown-content h1 { font-size: 1.5em; }
        .share-preview .markdown-content h2 { font-size: 1.4em; }
        .share-preview .markdown-content h3 { font-size: 1.3em; }
        .share-preview .markdown-content h4 { font-size: 1.2em; }
        .share-preview .markdown-content h5 { font-size: 1.1em; }
        .share-preview .markdown-content h6 { font-size: 1.0em; }
        
        .share-preview .markdown-content p {
            margin: 0.8em 0;
            line-height: 1.6;
        }
        
        .share-preview .markdown-content ul, .share-preview .markdown-content ol {
            margin: 1em 0;
            padding-left: 2em;
            line-height: 1.6;
        }
        
        .share-preview .markdown-content li {
            margin: 0.3em 0;
            line-height: 1.6;
        }
        
        .share-preview .markdown-content li ul, .share-preview .markdown-content li ol {
            margin: 0.5em 0;
        }
        
        .share-preview .markdown-content strong {
            font-weight: 600;
            color: #333;
        }
        
        .share-preview .markdown-content em {
            font-style: italic;
            color: #555;
        }
        
        .share-preview .markdown-content code {
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .share-preview .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        .share-preview .markdown-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
        }
        
        .share-preview .markdown-content blockquote {
            border-left: 4px solid #ddd;
            margin: 1em 0;
            padding-left: 1em;
            color: #666;
            font-style: italic;
        }
        
        .share-preview .thinking-section {
            border-top: 1px solid #eee;
            margin-top: 20px;
            padding-top: 15px;
        }
        
        .share-preview .thinking-label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #6f42c1;
        }
        
        .share-preview .sources-section {
            border-top: 1px solid #eee;
            margin-top: 20px;
            padding-top: 15px;
        }
        
        .share-preview .sources-label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2196f3;
        }
        
        .share-preview .header {
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 16px;
            margin-bottom: 20px;
        }
        
        .share-preview .header h3 {
            color: #ffffff;
            margin: 0;
            font-weight: 600;
        }
        
        .share-preview .question {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .share-preview .question-label {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .share-preview .answer {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 16px;
            border-radius: 0 8px 8px 0;
        }
        
        .share-preview .answer-label {
            font-weight: 600;
            color: #28a745;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .share-preview .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 2px solid #f0f0f0;
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .modal {
            z-index: 1055;
        }
        
        .modal-backdrop {
            z-index: 1050;
        }
        
        .document-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .document-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .document-meta {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .upload-zone.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .category-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            display: inline-block;
            margin-left: 8px;
        }
        
        /* Roaming Mode Styles */
        #threejsContainer canvas {
            border-radius: 8px;
        }
        
        .sentences-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .sentence-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            cursor: default;
            position: relative;
        }
        
        .sentence-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
        }
        
        .sentence-item:hover .copy-actions {
            opacity: 1;
            transform: translateY(0);
        }
        
        .sentence-text {
            line-height: 1.6;
            color: #2c3e50 !important;
            font-weight: 500;
            transition: none;
        }
        
        .sentence-source {
            font-size: 0.85em;
            color: #5a6c7d !important;
            margin-top: 8px;
            border-top: 1px solid #e9ecef;
            padding-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: none;
        }
        
        .copy-actions {
            display: flex;
            gap: 8px;
            opacity: 0.7;
            transform: translateY(2px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .copy-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .copy-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: #28a745;
        }
        
        .copy-btn i {
            font-size: 0.8em;
        }
        
        /* 句子选择功能样式 */
        .sentence-selection-header {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px 15px;
        }
        
        .sentence-selection-header .form-check-label {
            font-weight: 500;
            color: #495057;
        }
        
        .sentence-item .form-check-input:checked ~ * {
            opacity: 1;
        }
        
        .sentence-item .form-check-input:not(:checked) ~ * {
            opacity: 0.7;
        }
        
        .sentence-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
            transition: all 0.3s ease;
        }
        
        .sentence-item:hover .form-check-input:not(:checked) ~ * {
            opacity: 0.9;
        }
        
        #roamingSelectedCount, #keywordSelectedCount {
            font-size: 0.8em;
            min-width: 65px;
            text-align: center;
        }
        
        #rotationStatus {
            transition: all 0.3s ease;
        }
        
        #rotationStatus.paused {
            background: rgba(255, 193, 7, 0.8) !important;
        }
        
        .keyword-sphere {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .keyword-sphere:hover {
            transform: scale(1.1);
        }
        
        /* Book browser styles */
        .book-item {
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }
        
        .book-item:hover {
            border-color: #007bff;
            box-shadow: 0 5px 15px rgba(0,123,255,0.1);
        }
        
        .book-title {
            font-size: 0.95em;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }
        
        .book-content {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            font-family: 'Courier New', 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        /* Random Mode Styles */
        .random-quote-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .random-quote-text {
            font-size: 1.2em;
            line-height: 1.8;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        .stat-item {
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 10px;
        }
        
        .stat-item h5 {
            font-weight: 600;
            font-size: 1.8em;
        }
        
        .recent-quote-item {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .recent-quote-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }
        
        .recent-quote-text {
            font-size: 0.95em;
            color: #495057;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }
        
        .recent-quote-source {
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .random-mode-buttons {
            gap: 15px;
        }
        
        .random-mode-buttons .btn {
            transition: all 0.3s ease;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 500;
        }
        
        .random-mode-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* 书籍选择样式 */
        .book-card {
            transition: all 0.2s ease;
            border: 1px solid #dee2e6;
            height: 100%; /* 确保卡片高度一致 */
        }
        
        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .book-card.border-primary {
            border-color: #0d6efd !important;
            background-color: #f8f9ff;
        }
        
        .book-card .card-title {
            font-size: 0.85em;
            font-weight: 600;
            line-height: 1.3;
            /* 确保书名不超出容器 */
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            max-height: 2.6em; /* 限制最大高度为2行 */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .book-card .card-body {
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px;
        }
        
        .book-card .book-info {
            font-size: 0.75em;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        
        #selectedBooksList .badge {
            font-size: 0.8em;
            padding: 0.5em 0.8em;
            margin: 0.2em;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 书籍搜索样式 */
        #bookSearchInput {
            font-size: 0.9em;
        }
        
        #bookFilterStatus {
            color: #198754;
            font-weight: 500;
        }
        
        /* 速度控制样式 */
        .speed-control-container {
            background: #f8f9fa;
            border-radius: 25px;
            padding: 12px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .speed-control-container .form-label {
            font-weight: 500;
            color: #495057;
        }
        
        .speed-control-container .form-range {
            accent-color: #007bff;
        }
        
        .speed-control-container .badge {
            font-size: 0.9em;
            padding: 8px 12px;
        }
        
        /* 随机模式关键词筛选样式 - 与关键词检索保持一致 */
        .random-keyword-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .random-keyword-item:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .random-keyword-item.selected {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .random-selected-keyword {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.9em;
            color: #1976d2;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .random-selected-keyword .remove-btn {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            padding: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .random-selected-keyword .remove-btn:hover {
            background: #1976d2;
            color: white;
        }
        
        /* 随机句子文本样式 */
        #randomQuoteText {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        #randomQuoteText div {
            transition: all 0.3s ease;
            padding: 2px 0;
        }
        
        #randomQuoteText div:hover {
            color: #007bff;
        }
        
        /* 全屏模式样式 */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease, background 1.5s ease-in-out;
        }
        
        /* 背景渐变动画 - 仅在显示时激活 */
        .fullscreen-overlay.show {
            opacity: 1;
        }
        
        /* 预定义的背景渐变样式 */
        .fullscreen-overlay.bg-gradient-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .fullscreen-overlay.bg-gradient-2 {
            background: linear-gradient(135deg, #764ba2 0%, #c94b4b 100%);
        }
        
        .fullscreen-overlay.bg-gradient-3 {
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
        }
        
        .fullscreen-overlay.bg-gradient-4 {
            background: linear-gradient(135deg, #4b134f 0%, #2c3e50 100%);
        }
        
        .fullscreen-overlay.bg-gradient-5 {
            background: linear-gradient(135deg, #2c3e50 0%, #3f4c6b 100%);
        }
        
        .fullscreen-overlay.bg-gradient-6 {
            background: linear-gradient(135deg, #3f4c6b 0%, #667eea 100%);
        }
        
        .fullscreen-content {
            text-align: center;
            color: white;
            max-width: 90%;
            width: 100%;
            position: relative;
            padding: 5vh 5vw; /* 适当留白 */
            box-sizing: border-box;
        }
        
        .fullscreen-quote-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 90vh; /* 留出上下边距 */
            width: 100%;
        }
        
        .fullscreen-quote-text {
            font-size: 3.5em;
            line-height: 1.6;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 40px;
            font-family: 'Georgia', 'Times New Roman', serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            /* 自适应字体大小 */
            font-size: clamp(1.5em, 5vw, 5em);
            max-height: 70vh; /* 限制最大高度 */
            overflow: auto;
            word-wrap: break-word;
            word-break: break-word;
            /* 柔和的过渡动画 */
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
        }
        
        .fullscreen-quote-text.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }
        
        .fullscreen-quote-text.fade-in {
            opacity: 1;
            transform: translateY(0);
        }
        
        .fullscreen-quote-text div {
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .fullscreen-quote-source {
            font-size: clamp(0.8em, 2.5vw, 1.5em); /* 自适应字体大小 */
            opacity: 0.8;
            font-style: italic;
            margin-top: 30px;
            margin-bottom: 30px; /* 底部留白 */
            /* 柔和的过渡动画 */
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
            transform: translateY(0);
        }
        
        .fullscreen-quote-source.fade-out {
            opacity: 0;
            transform: translateY(20px);
        }
        
        .fullscreen-quote-source.fade-in {
            opacity: 0.8;
            transform: translateY(0);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .fullscreen-content {
                padding: 3vh 3vw; /* 移动设备减少边距 */
            }
            .fullscreen-quote-container {
                height: 94vh; /* 移动设备更多可用空间 */
            }
        }
        
        @media (max-height: 600px) {
            .fullscreen-content {
                padding: 2vh 2vw; /* 低矮屏幕减少边距 */
            }
            .fullscreen-quote-container {
                height: 96vh;
            }
        }
        
        .book-item .card-footer {
            padding: 0.5rem 1rem;
            background: rgba(0,123,255,0.05) !important;
        }
        
        .book-item:hover .card-footer {
            background: rgba(0,123,255,0.1) !important;
        }
        
        /* Book list styles for sidebar */
        .book-list-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #ffffff;
        }
        
        .book-list-item:hover {
            background: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        
        .book-list-item.active {
            background: #e3f2fd;
            border-left: 3px solid #007bff;
            font-weight: 500;
        }
        
        .book-list-item.active .book-list-title {
            color: #007bff;
        }
        
        .book-list-title {
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }
        
        .book-list-meta {
            font-size: 0.75em;
            color: #6c757d;
        }
        
        .book-list-container {
            border-right: 1px solid #e9ecef;
        }
        
        .book-list-container::-webkit-scrollbar {
            width: 4px;
        }
        
        .book-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .book-list-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        .book-list-container::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><img src="/static/logo.png" alt="品牌Logo" style="height: 80px; vertical-align: middle;"></h1>
                <p class="mb-0" style="font-size: 0.9em; opacity: 0.9;">本地化读书笔记智能助手</p>
            </div>
            
            <!-- Content -->
            <div class="p-4">
                <!-- Navigation Tabs -->
                <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
                            <i class="bi bi-chat-dots"></i> 智能问答
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="keyword-tab" data-bs-toggle="tab" data-bs-target="#keyword" type="button" role="tab">
                            <i class="bi bi-search"></i> 关键词检索
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="roaming-tab" data-bs-toggle="tab" data-bs-target="#roaming" type="button" role="tab">
                            <i class="bi bi-globe"></i> 漫游模式
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="random-tab" data-bs-toggle="tab" data-bs-target="#random" type="button" role="tab">
                            <i class="bi bi-shuffle"></i> 随机模式
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="books-tab" data-bs-toggle="tab" data-bs-target="#books" type="button" role="tab">
                            <i class="bi bi-book-half"></i> 书籍浏览
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button" role="tab">
                            <i class="bi bi-file-earmark-text"></i> 文档管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button" role="tab">
                            <i class="bi bi-list-check"></i> 批量测试
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab">
                            <i class="bi bi-info-circle"></i> 系统状态
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="mainTabContent">
                    <!-- Chat Tab -->
                    <div class="tab-pane fade show active" id="chat" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <!-- Chat Messages -->
                                <div class="chat-container" id="chatContainer">
                                    <div class="text-center text-muted">
                                        <i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>
                                        <p class="mt-3">欢迎使用「知行」！<br>请在下方输入您的问题，我会基于您的读书笔记为您提供准确的回答。</p>
                                    </div>
                                </div>
                                
                                <!-- Loading indicator -->
                                <div class="loading" id="loading">
                                    <div class="spinner-border" role="status"></div>
                                    <p class="mt-2">正在思考中...</p>
                                </div>
                                
                                <!-- Input -->
                                <div class="input-group">
                                    <input type="text" class="form-control" id="questionInput" placeholder="请输入您的问题..." maxlength="500">
                                    <button class="btn btn-primary" type="button" id="askButton">
                                        <i class="bi bi-send"></i> 提问
                                    </button>
                                </div>
                                
                                <div class="mt-3 text-center">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showThinkingProcess" checked>
                                        <label class="form-check-label" for="showThinkingProcess">
                                            <small>显示AI思考过程</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="useStreamMode" checked>
                                        <label class="form-check-label" for="useStreamMode">
                                            <small>使用流式显示</small>
                                        </label>
                                    </div>
                                    <br>
                                    <button class="btn btn-outline-secondary btn-sm me-2 mt-2" onclick="clearChat()">
                                        <i class="bi bi-trash"></i> 清空对话
                                    </button>
                                    <small class="text-muted">支持基于读书笔记的智能问答</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Keyword Search Tab -->
                    <div class="tab-pane fade" id="keyword" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <div class="text-center mb-4">
                                    <h4><i class="bi bi-search"></i> 关键词检索</h4>
                                    <p class="text-muted">根据关键词快速检索相关句子内容</p>
                                </div>
                                
                                <!-- Search Section -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="bi bi-search"></i> 搜索关键词</h6>
                                        <small class="text-muted">支持复制功能：单句复制、全部复制、勾选复制，支持 Ctrl+C 智能复制</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="keywordInput" placeholder="输入关键词进行搜索..." maxlength="100">
                                            <button class="btn btn-primary" type="button" id="searchKeywordBtn">
                                                <i class="bi bi-search"></i> 搜索
                                            </button>
                                        </div>
                                        
                                        <!-- Keywords Results -->
                                        <div id="keywordResults" class="mb-3" style="display: none;">
                                            <h6>候选关键词：</h6>
                                            <div id="keywordList" class="d-flex flex-wrap gap-2"></div>
                                        </div>
                                        
                                        <!-- Selected Keywords -->
                                        <div id="selectedKeywords" class="mb-3" style="display: none;">
                                            <h6>已选关键词：</h6>
                                            <div id="selectedKeywordList" class="d-flex flex-wrap gap-2"></div>
                                            <button class="btn btn-success btn-sm mt-2" id="getSentencesBtn">
                                                <i class="bi bi-list-ul"></i> 获取相关句子
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Sentences Results -->
                                <div id="sentencesSection" class="card" style="display: none;">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1"><i class="bi bi-list-ul"></i> 相关句子</h6>
                                            <small class="text-muted">共 <span id="sentenceCount" class="badge bg-primary"></span> 条</small>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-success btn-sm" onclick="copyAllKeywordSentences()" title="复制所有句子">
                                                <i class="bi bi-files"></i> 全部复制
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="closeSentencesSection()" title="关闭">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                        <div id="sentencesList"></div>
                                    </div>
                                </div>
                                
                                <!-- Statistics -->
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="bi bi-bar-chart"></i> 检索统计</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="keywordStats">
                                                    <div class="text-center text-muted">
                                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                                        <span class="ms-2">加载中...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="bi bi-gear"></i> 系统操作</h6>
                                            </div>
                                            <div class="card-body">
                                                <button class="btn btn-outline-primary btn-sm me-2" id="refreshStatsBtn">
                                                    <i class="bi bi-arrow-clockwise"></i> 刷新统计
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm" id="rebuildKeywordIndexBtn">
                                                    <i class="bi bi-arrow-repeat"></i> 重建索引
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Roaming Mode Tab -->
                    <div class="tab-pane fade" id="roaming" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <div class="text-center mb-4">
                                    <h4><i class="bi bi-globe"></i> 漫游模式</h4>
                                    <p class="text-muted">3D球形展示高频关键词，探索知识网络</p>
                                </div>
                                
                                <!-- Loading indicator -->
                                <div id="roamingLoading" class="text-center" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3">正在加载关键词数据...</p>
                                </div>
                                
                                <!-- 3D Visualization Container -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="bi bi-diagram-3"></i> 关键词3D球形图</h6>
                                        <small class="text-muted">点击关键词查看相关句子，再次点击取消选定</small>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="threejsContainer" style="height: 500px; position: relative; overflow: hidden;">
                                            <canvas id="threejsCanvas"></canvas>
                                            <!-- Control hints -->
                                            <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.8em;">
                                                <div>🖱️ 拖拽：旋转</div>
                                                <div>🖱️ 滚轮：缩放</div>
                                                <div>🖱️ 点击：选择关键词</div>
                                                <div>⌨️ Ctrl+C：智能复制</div>
                                                <div>☑️ 勾选：选择句子</div>
                                            </div>
                                            <!-- Status indicator -->
                                            <div id="rotationStatus" style="position: absolute; top: 10px; left: 10px; background: rgba(76, 175, 80, 0.8); color: white; padding: 6px 10px; border-radius: 3px; font-size: 0.8em;">
                                                🔄 自动旋转中
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Selected Keyword Info -->
                                <div id="selectedKeywordInfo" class="card" style="display: none;">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 id="selectedKeywordTitle" class="mb-1"><i class="bi bi-bookmark-star"></i> 选中关键词: <span id="selectedKeywordName"></span></h6>
                                            <small class="text-muted">出现频次: <span id="selectedKeywordCount"></span> 次</small>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-primary btn-sm" onclick="copyAllSentences()" title="复制所有句子">
                                                <i class="bi bi-files"></i> 全部复制
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="closeKeywordInfo()" title="关闭">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="selectedKeywordSentences" class="sentences-container" style="max-height: 400px; overflow-y: auto;">
                                            <!-- Related sentences will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Random Mode Tab -->
                    <div class="tab-pane fade" id="random" role="tabpanel">
                        <div class="row justify-content-center">
                            <div class="col-lg-8">
                                <div class="text-center mb-4">
                                    <h4><i class="bi bi-shuffle"></i> 随机模式</h4>
                                    <p class="text-muted">随机展示书籍中的精彩句子，开启意外发现之旅</p>
                                </div>
                                
                                <!-- Control Buttons - 移到上方 -->
                                <div class="text-center mb-4 random-mode-buttons">
                                    <button id="getNewRandomQuote" class="btn btn-primary btn-lg me-3" style="min-width: 120px;">
                                        <i class="bi bi-arrow-clockwise"></i> 换一换
                                    </button>
                                    <button id="autoPlayToggle" class="btn btn-outline-success btn-lg me-3" style="min-width: 120px;">
                                        <i class="bi bi-play-fill"></i> 自动播放
                                    </button>
                                    <button id="copyRandomQuote" class="btn btn-outline-secondary btn-lg me-3" style="min-width: 120px;" disabled>
                                        <i class="bi bi-clipboard"></i> 复制
                                    </button>
                                    <button id="enterFullscreen" class="btn btn-outline-info btn-lg" style="min-width: 120px;">
                                        <i class="bi bi-arrows-fullscreen"></i> 全屏
                                    </button>
                                </div>
                                
                                <!-- Speed Control -->
                                <div class="text-center mb-4">
                                    <div class="d-inline-flex align-items-center speed-control-container">
                                        <label for="autoPlaySpeed" class="form-label me-3 mb-0">播放间隔:</label>
                                        <input type="range" class="form-range me-3" id="autoPlaySpeed" min="0.1" max="30" step="0.1" value="0.5" style="width: 200px;">
                                        <span id="speedDisplay" class="badge bg-secondary me-3" style="min-width: 60px;">0.5秒</span>
                                        
                                        <!-- 快捷速度按钮 -->
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setSpeed(0.3)">快</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setSpeed(0.5)">中</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setSpeed(1)">慢</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Filters Section -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="bi bi-funnel"></i> 筛选设置</h6>
                                        <small class="text-muted">选择特定书籍和关键词来自定义随机展示范围</small>
                                    </div>
                                    <div class="card-body">
                                        <!-- Book Selection -->
                                        <div class="mb-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="bi bi-book"></i> 书籍选择</h6>
                                                <div>
                                                    <button class="btn btn-outline-primary btn-sm me-2" id="loadBooksBtn">
                                                        <i class="bi bi-arrow-clockwise"></i> 加载书籍
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm me-2" id="selectAllBooksBtn" style="display: none;">
                                                        <i class="bi bi-check-all"></i> 全选
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" id="clearBookSelectionBtn" style="display: none;">
                                                        <i class="bi bi-x-circle"></i> 清空
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Book Search -->
                                            <div id="bookSearchArea" class="mb-3" style="display: none;">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="bookSearchInput" placeholder="搜索书名..." maxlength="50">
                                                    <button class="btn btn-outline-secondary" type="button" id="clearBookSearchBtn">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </div>
                                                <small class="text-muted">支持模糊搜索书名</small>
                                            </div>
                                            
                                            <!-- Books List -->
                                            <div id="bookSelectionArea" style="display: none;">
                                                <div class="alert alert-info alert-sm">
                                                    <i class="bi bi-info-circle"></i> 未选择书籍时将从所有书籍中随机展示句子
                                                </div>
                                                
                                                <!-- Books Count and Filter Status -->
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <small class="text-muted">
                                                        显示 <span id="displayedBooksCount">0</span> / <span id="totalBooksCount">0</span> 本书籍
                                                    </small>
                                                    <small class="text-muted" id="bookFilterStatus" style="display: none;">
                                                        <i class="bi bi-funnel"></i> 已筛选
                                                    </small>
                                                </div>
                                                
                                                <div id="booksList" class="row" style="max-height: 350px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 0.375rem; padding: 1rem; background-color: #f8f9fa;">
                                                    <!-- 书籍列表将在这里动态加载 -->
                                                </div>
                                            </div>
                                            
                                            <!-- Selected Books Display -->
                                            <div id="selectedBooksDisplay" class="mt-3" style="display: none;">
                                                <h6>已选书籍 (<span id="selectedBooksCount">0</span>)：</h6>
                                                <div id="selectedBooksList" class="d-flex flex-wrap gap-2"></div>
                                            </div>
                                        </div>
                                        
                                        <hr>
                                        
                                        <!-- Keyword Filter -->
                                        <div>
                                            <h6><i class="bi bi-tags"></i> 关键词筛选</h6>
                                            <small class="text-muted">选择关键词后将只在包含这些关键词的句子中随机展示</small>
                                            
                                            <!-- Search Input -->
                                            <div class="input-group mt-3 mb-3">
                                                <input type="text" class="form-control" id="randomKeywordInput" placeholder="输入关键词进行搜索..." maxlength="100">
                                                <button class="btn btn-primary" type="button" id="searchRandomKeywordsBtn">
                                                    <i class="bi bi-search"></i> 搜索
                                                </button>
                                            </div>
                                            
                                            <!-- Keywords Results -->
                                            <div id="randomKeywordResults" class="mb-3" style="display: none;">
                                                <h6>候选关键词：</h6>
                                                <div id="randomKeywordList" class="d-flex flex-wrap gap-2"></div>
                                            </div>
                                            
                                            <!-- Selected Keywords -->
                                            <div id="randomSelectedKeywords" class="mb-3" style="display: none;">
                                                <h6>已选关键词：</h6>
                                                <div id="randomSelectedKeywordList" class="d-flex flex-wrap gap-2"></div>
                                                <div class="mt-2">
                                                    <button class="btn btn-success btn-sm me-2" id="getRandomFilteredSentencesBtn">
                                                        <i class="bi bi-list-ul"></i> 应用筛选
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" id="clearRandomFilterBtn">
                                                        <i class="bi bi-x-circle"></i> 清空筛选
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Filter Status -->
                                        <div id="randomFilterStatus" class="alert alert-info" style="display: none;">
                                            <i class="bi bi-info-circle"></i> 
                                            <span id="randomFilterStatusText">未应用筛选，将从所有句子中随机展示</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Random Quote Display -->
                                <div class="card shadow-sm mb-4">
                                    <div class="card-body text-center">
                                        <div id="randomQuoteLoading" class="text-center" style="display: block;">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="text-muted">正在随机选择句子...</p>
                                        </div>
                                        
                                        <div id="randomQuoteContent" style="display: none;">
                                            <blockquote class="blockquote mb-0">
                                                <div class="mb-0" id="randomQuoteText" style="font-size: 1.2em; line-height: 2; color: #2c3e50; min-height: 100px; text-align: center; padding: 20px;">
                                                    <!-- 随机句子将显示在这里 -->
                                                </div>
                                            </blockquote>
                                            <footer class="blockquote-footer mt-3">
                                                来自 <cite title="Source Title" id="randomQuoteSource">未知书籍</cite>
                                            </footer>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Statistics -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="bi bi-graph-up"></i> 随机统计</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-4">
                                                <div class="stat-item">
                                                    <h5 class="text-primary mb-1" id="totalQuotesCount">-</h5>
                                                    <p class="text-muted mb-0">总句子数</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="stat-item">
                                                    <h5 class="text-success mb-1" id="currentSessionCount">0</h5>
                                                    <p class="text-muted mb-0">本次浏览</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="stat-item">
                                                    <h5 class="text-info mb-1" id="uniqueBooksCount">-</h5>
                                                    <p class="text-muted mb-0">涉及书籍</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Recent Quotes History -->
                                <div class="card mt-4">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6><i class="bi bi-clock-history"></i> 最近浏览</h6>
                                        <button id="clearHistory" class="btn btn-outline-danger btn-sm">
                                            <i class="bi bi-trash"></i> 清空
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="recentQuotesContainer" style="max-height: 300px; overflow-y: auto;">
                                            <p class="text-muted text-center">还没有浏览记录</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Books Tab -->
                    <div class="tab-pane fade" id="books" role="tabpanel">
                        <div class="text-center mb-3">
                            <h4><i class="bi bi-book-half"></i> 书籍浏览</h4>
                            <p class="text-muted">浏览和查看笔记中的书籍内容</p>
                        </div>
                        
                        <div class="row" style="height: 75vh; max-height: 600px;">
                            <!-- Left sidebar - Book List -->
                            <div class="col-md-4 col-lg-3">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                                        <h6 class="mb-0"><i class="bi bi-list"></i> 书籍列表</h6>
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshBookList()" title="刷新列表">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="bookList" class="book-list-container" style="height: calc(100% - 60px); overflow-y: auto; max-height: 500px;">
                                            <div class="text-center p-3">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                                <p class="mt-2 mb-0 small">加载中...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right content - Book Content -->
                            <div class="col-md-8 col-lg-9">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center py-2" id="bookContentHeader">
                                        <div>
                                            <h6 class="mb-0" id="bookContentTitle">
                                                <i class="bi bi-book-open"></i> 
                                                <span id="bookContentName">请从左侧选择书籍</span>
                                            </h6>
                                            <small class="text-muted" id="bookContentMeta" style="display: none;">
                                                文件大小: <span id="bookFileSize"></span> | 
                                                行数: <span id="bookLineCount"></span> | 
                                                字符数: <span id="bookCharCount"></span>
                                            </small>
                                        </div>
                                        <div class="d-flex gap-2" id="bookContentActions" style="display: none;">
                                            <button class="btn btn-outline-success btn-sm" onclick="copyBookContent()" title="复制全部内容">
                                                <i class="bi bi-files"></i> 复制
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0" style="height: calc(100% - 60px); position: relative;">
                                        <div id="bookContentContainer" class="h-100 d-flex align-items-center justify-content-center" style="background: #f8f9fa; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                                            <div class="text-center text-muted">
                                                <i class="bi bi-book" style="font-size: 3rem;"></i>
                                                <p class="mt-3 mb-0">请从左侧书籍列表中选择一本书查看内容</p>
                                            </div>
                                        </div>
                                        <div id="bookContentText" class="book-content p-3" style="height: 100%; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; font-size: 0.95em; display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                                            <!-- 书籍内容将在这里显示 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Document Management Tab -->
                    <div class="tab-pane fade" id="docs" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <div class="text-center mb-4">
                                    <h4><i class="bi bi-file-earmark-text"></i> 文档管理</h4>
                                    <p class="text-muted">批量导入txt文件，增量更新向量索引</p>
                                </div>
                                
                                <!-- File Upload Section -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="bi bi-upload"></i> 文件上传</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="fileInput" class="form-label">选择文本文件（支持多选）</label>
                                            <input type="file" class="form-control" id="fileInput" multiple accept=".txt,text/plain,*" />
                                            <div class="form-text">支持同时选择多个txt文件或无后缀的文本文件进行批量上传</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="categoryInput" class="form-label">文档分类（可选）</label>
                                            <input type="text" class="form-control" id="categoryInput" placeholder="例如：读书笔记、会议记录、项目文档等" />
                                            <div class="form-text">为上传的文档指定分类，便于后续管理和检索</div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" id="uploadButton" onclick="uploadDocuments()">
                                                <i class="bi bi-cloud-upload"></i> 开始上传
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="clearFileSelection()">
                                                <i class="bi bi-x-circle"></i> 清空选择
                                            </button>
                                        </div>
                                        
                                        <!-- Upload Progress -->
                                        <div id="uploadProgress" class="mt-3" style="display: none;">
                                            <div class="progress">
                                                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <div id="uploadStatus" class="mt-2 text-center">
                                                <small class="text-muted">准备上传...</small>
                                            </div>
                                        </div>
                                        
                                        <!-- Upload Results -->
                                        <div id="uploadResults" class="mt-3"></div>
                                    </div>
                                </div>
                                
                                <!-- Document List Section -->
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6><i class="bi bi-list"></i> 已导入文档</h6>
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshDocumentList()">
                                            <i class="bi bi-arrow-clockwise"></i> 刷新列表
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="documentList">
                                            <div class="text-center">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                                <span class="ms-2">加载中...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Batch Test Tab -->
                    <div class="tab-pane fade" id="batch" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <div class="text-center mb-4">
                                    <h4><i class="bi bi-list-check"></i> 批量测试模式</h4>
                                    <p class="text-muted">测试系统对预设问题的回答质量</p>
                                    <button class="btn btn-primary" id="runTestButton">
                                        <i class="bi bi-play-circle"></i> 开始测试
                                    </button>
                                </div>
                                
                                <div id="testResults"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Tab -->
                    <div class="tab-pane fade" id="status" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card status-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-cpu" style="font-size: 2rem; color: #007bff;"></i>
                                        <h5 class="card-title mt-3">系统状态</h5>
                                        <div id="systemStatus">
                                            <span class="badge bg-secondary">检查中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card status-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-database" style="font-size: 2rem; color: #28a745;"></i>
                                        <h5 class="card-title mt-3">文档库</h5>
                                        <div id="documentStatus">
                                            <span class="badge bg-secondary">检查中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card status-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-brain" style="font-size: 2rem; color: #6f42c1;"></i>
                                        <h5 class="card-title mt-3">AI模型</h5>
                                        <div id="modelStatus">
                                            <span class="badge bg-secondary">检查中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card status-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-tools" style="font-size: 2rem; color: #fd7e14;"></i>
                                        <h5 class="card-title mt-3">系统控制</h5>
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshStatus()">
                                            <i class="bi bi-arrow-clockwise"></i> 刷新状态
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm mt-2" onclick="reinitSystem()">
                                            <i class="bi bi-bootstrap-reboot"></i> 重新初始化
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="bi bi-info-circle"></i> 详细信息</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="detailedStatus">
                                            <div class="text-center">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                                <span class="ms-2">加载中...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center py-3" style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 20px;">
        created by kd, built by ai
    </footer>
    
    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">
                        <i class="bi bi-share"></i> 分享对话
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="sharePreview" class="share-preview">
                        <!-- 分享内容将在这里动态生成 -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" onclick="downloadShareImage()">
                            <i class="bi bi-download"></i> 下载图片
                        </button>
                        <button class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">
                            <i class="bi bi-x"></i> 取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 全屏模式覆盖层 -->
    <div id="fullscreenOverlay" class="fullscreen-overlay" style="display: none;">
        <div class="fullscreen-content">
            <div class="fullscreen-quote-container">
                <div id="fullscreenQuoteText" class="fullscreen-quote-text">
                    <!-- 全屏句子内容 -->
                </div>
                <div id="fullscreenQuoteSource" class="fullscreen-quote-source">
                    <!-- 全屏句子来源 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 配置 Marked 库
        marked.setOptions({
            breaks: true,        // 启用换行符转换
            gfm: true,          // 启用 GitHub Flavored Markdown
            tables: true,       // 启用表格
            sanitize: false,    // 不进行HTML清理
            smartLists: false,  // 禁用智能列表，保持原始数字
            smartypants: false, // 禁用智能标点
            pedantic: false,    // 不使用严格模式
            headerIds: false,   // 不生成header ID
            mangle: false,      // 不转义特殊字符
            renderer: new marked.Renderer()
        });
        
        // 自定义渲染器，确保列表正确渲染
        const renderer = new marked.Renderer();
        renderer.list = function(body, ordered) {
            const type = ordered ? 'ol' : 'ul';
            return `<${type} style="display: block; padding-left: 2em; list-style-type: ${ordered ? 'decimal' : 'disc'};">${body}</${type}>`;
        };
        renderer.listitem = function(text) {
            return `<li style="display: list-item; margin-bottom: 0.5em;">${text}</li>`;
        };
        renderer.paragraph = function(text) {
            return `<p style="margin-bottom: 1em; line-height: 1.6;">${text}</p>`;
        };
        marked.use({ renderer });
        
        // 禁用marked.js的自动列表编号
        marked.setOptions({
            smartLists: false,
            pedantic: false
        });
        
        // Global variables
        let chatHistory = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            refreshDocumentList();
            
            // 配置marked.js
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {}
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true,
                smartLists: true,
                pedantic: false,
                headerIds: false,
                mangle: false
            });
            
            // Enter key support
            document.getElementById('questionInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    askQuestion();
                }
            });
            
            // Ask button click
            document.getElementById('askButton').addEventListener('click', askQuestion);
            
            // Batch test button
            document.getElementById('runTestButton').addEventListener('click', runBatchTest);
            
            // File input change event
            document.getElementById('fileInput').addEventListener('change', handleFileSelection);
        });
        
        // Ask question function
        async function askQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            const showThinking = document.getElementById('showThinkingProcess').checked;
            const useStreamMode = document.getElementById('useStreamMode').checked;
            
            if (!question) {
                alert('请输入问题');
                return;
            }
            
            // Add user message to chat
            addMessage('user', question);
            input.value = '';
            
            if (useStreamMode) {
                // 使用流式模式
                await askQuestionStream(question, showThinking, input);
            } else {
                // 使用普通模式
                await askQuestionNormal(question, showThinking, input);
            }
        }
        
        // 流式问答
        async function askQuestionStream(question, showThinking, input) {
            // 禁用输入和按钮
            input.disabled = true;
            document.getElementById('askButton').disabled = true;
            
            // 创建流式显示的消息容器
            const streamMessageId = 'stream_' + Date.now();
            addStreamMessage(streamMessageId, question);
            
            try {
                // 使用流式API
                const response = await fetch('/api/ask_stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question,
                        show_thinking: showThinking
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleStreamData(streamMessageId, data);
                            } catch (e) {
                                console.error('解析流数据错误:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('流式请求错误:', error);
                updateStreamMessage(streamMessageId, 'error', `网络错误: ${error.message}`);
            } finally {
                // 重新启用输入和按钮
                input.disabled = false;
                document.getElementById('askButton').disabled = false;
            }
        }
        
        // 普通问答
        async function askQuestionNormal(question, showThinking, input) {
            // Show loading
            document.getElementById('loading').style.display = 'block';
            scrollToBottom();
            
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question,
                        show_thinking: showThinking
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addMessage('bot', data.answer, data.confidence, data.sources, data.show_thinking, question);
                } else {
                    addMessage('bot', `错误: ${data.error}`, 0, [], false, question);
                }
            } catch (error) {
                addMessage('bot', `网络错误: ${error.message}`, 0, [], false, question);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Add message to chat
        function addMessage(type, content, confidence = null, sources = [], showThinking = false, question = '') {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            let messageHTML = '';
            
            if (type === 'bot' && showThinking) {
                // 分离思考过程和最终回答
                const thinkingMatch = content.match(/<think>(.*?)<\/think>/s);
                if (thinkingMatch) {
                    const thinkingContent = thinkingMatch[1].trim();
                    const finalAnswer = content.replace(/<think>.*?<\/think>/s, '').trim();
                    
                    messageHTML = `
                        <div class="message-bubble">
                            <div class="markdown-content">${marked.parse(finalAnswer)}</div>
                            <div class="thinking-toggle">
                                <a href="#" onclick="toggleThinking(this)" class="text-muted">
                                    <i class="bi bi-eye"></i> 查看AI思考过程
                                </a>
                            </div>
                            <div class="thinking-process" style="display: none;">
                                <strong><i class="bi bi-brain"></i> AI思考过程：</strong><br>
                                ${thinkingContent.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                } else {
                    messageHTML = `
                        <div class="message-bubble">
                            <div class="markdown-content">${marked.parse(content)}</div>
                        </div>
                    `;
                }
            } else if (type === 'bot') {
                messageHTML = `
                    <div class="message-bubble">
                        <div class="markdown-content">${marked.parse(content)}</div>
                    </div>
                `;
            } else {
                messageHTML = `
                    <div class="message-bubble">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                `;
            }
            
            if (type === 'bot' && confidence !== null) {
                const confidenceColor = confidence > 0.8 ? 'success' : confidence > 0.5 ? 'warning' : 'danger';
                messageHTML += `
                    <div class="confidence-badge">
                        <span class="badge bg-${confidenceColor}">
                            置信度: ${(confidence * 100).toFixed(1)}%
                        </span>
                        <button class="share-button ms-2" onclick="shareConversation(this)" data-question="${question || ''}" data-answer="${content.replace(/"/g, '&quot;')}" data-confidence="${confidence}">
                            <i class="bi bi-share"></i> 分享
                        </button>
                    </div>
                `;
                
                if (sources && sources.length > 0) {
                    messageHTML += `
                        <div class="sources-info">
                            <strong><i class="bi bi-book"></i> 参考来源 (${sources.length}个):</strong><br>
                    `;
                    sources.forEach(source => {
                        messageHTML += `
                            • ${source.filename} (相似度: ${(source.score * 100).toFixed(1)}%)<br>
                        `;
                    });
                    messageHTML += '</div>';
                }
            }
            
            messageDiv.innerHTML = messageHTML;
            chatContainer.appendChild(messageDiv);
            
            // 高亮代码块
            messageDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
            
            // Remove welcome message if exists
            const welcomeMsg = chatContainer.querySelector('.text-center.text-muted');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            scrollToBottom();
        }
        
        // 添加流式消息容器
        function addStreamMessage(messageId, question = '') {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            messageDiv.id = messageId;
            messageDiv.setAttribute('data-question', question);
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="streaming-status" id="${messageId}_status">
                        🚀 正在初始化...
                    </div>
                    <div class="thinking-toggle-container" id="${messageId}_thinking_toggle" style="display: none;">
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleThinkingProcess('${messageId}')">
                            <i class="bi bi-eye"></i> 查看AI思考过程
                        </button>
                    </div>
                    <div class="thinking-process" id="${messageId}_thinking" style="display: none;">
                        <strong><i class="bi bi-brain"></i> AI思考过程：</strong><br>
                        <div id="${messageId}_thinking_content" class="markdown-content"></div>
                    </div>
                    <div class="markdown-content" id="${messageId}_answer"></div>
                    <div class="confidence-badge" id="${messageId}_confidence" style="display: none;"></div>
                    <div class="sources-info" id="${messageId}_sources" style="display: none;"></div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            
            // Remove welcome message if exists
            const welcomeMsg = chatContainer.querySelector('.text-center.text-muted');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            scrollToBottom();
        }
        
        // 处理流式数据
        function handleStreamData(messageId, data) {
            const statusDiv = document.getElementById(`${messageId}_status`);
            const thinkingDiv = document.getElementById(`${messageId}_thinking`);
            const thinkingToggleDiv = document.getElementById(`${messageId}_thinking_toggle`);
            const thinkingContentDiv = document.getElementById(`${messageId}_thinking_content`);
            const answerDiv = document.getElementById(`${messageId}_answer`);
            const confidenceDiv = document.getElementById(`${messageId}_confidence`);
            const sourcesDiv = document.getElementById(`${messageId}_sources`);
            
            switch (data.type) {
                case 'start':
                    // 显示开始信息
                    statusDiv.innerHTML = '<div class="step-indicator">🚀 开始处理问题...</div>';
                    break;
                    
                case 'step':
                    // 只显示当前步骤，不累积
                    statusDiv.innerHTML = `
                        <div class="step-indicator">
                            <div class="spinner-border spinner-border-sm me-2" style="width: 1rem; height: 1rem;"></div>
                            <strong>[${data.step}]</strong> ${data.message}
                        </div>
                    `;
                    scrollToBottom();
                    break;
                    
                case 'step_complete':
                    // 完成后直接更新为下一个状态的准备（如果有的话）
                    // 这里暂时显示完成状态，很快会被下一个步骤覆盖
                    statusDiv.innerHTML = `
                        <div class="step-indicator completed">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>[${data.step}]</strong> ${data.message}
                        </div>
                    `;
                    
                    scrollToBottom();
                    break;
                    
                case 'thinking_start':
                    // 显示思考状态
                    statusDiv.innerHTML = `
                        <div class="step-indicator">
                            <div class="spinner-border spinner-border-sm me-2" style="width: 1rem; height: 1rem;"></div>
                            <strong>[AI思考]</strong> 🤔 AI正在深度思考...
                        </div>
                    `;
                    thinkingContentDiv.innerHTML = '';
                    
                    // 如果勾选了显示思考过程，则实时显示思考过程
                    const showThinkingChecked = document.getElementById('showThinkingProcess').checked;
                    if (showThinkingChecked) {
                        thinkingDiv.style.display = 'block';
                        thinkingToggleDiv.style.display = 'none';
                    }
                    
                    scrollToBottom();
                    break;
                    
                case 'thinking_chunk':
                    // 累积思考内容并用markdown渲染
                    const currentThinkingContent = thinkingContentDiv.getAttribute('data-thinking-content') || '';
                    const newThinkingContent = currentThinkingContent + data.content;
                    thinkingContentDiv.setAttribute('data-thinking-content', newThinkingContent);
                    thinkingContentDiv.innerHTML = marked.parse(newThinkingContent);
                    
                    scrollToBottom();
                    break;
                    
                case 'thinking_end':
                    // 思考完成，显示思考过程查看按钮
                    statusDiv.innerHTML = `
                        <div class="step-indicator completed">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>[AI思考]</strong> ✅ AI思考完成
                        </div>
                    `;
                    
                    // 如果没有勾选显示思考过程，显示查看思考过程的按钮
                    const showThinkingChecked2 = document.getElementById('showThinkingProcess').checked;
                    if (!showThinkingChecked2 && thinkingContentDiv.innerHTML.trim()) {
                        thinkingToggleDiv.style.display = 'block';
                    }
                    
                    scrollToBottom();
                    break;
                    
                case 'answer_start':
                    // 显示答案生成状态
                    statusDiv.innerHTML = `
                        <div class="step-indicator">
                            <div class="spinner-border spinner-border-sm me-2" style="width: 1rem; height: 1rem;"></div>
                            <strong>[生成答案]</strong> 💬 正在生成回答...
                        </div>
                    `;
                    
                    answerDiv.innerHTML = '';
                    answerDiv.classList.add('typing-effect');
                    scrollToBottom();
                    break;
                    
                case 'answer_chunk':
                    // 累积内容
                    const currentContent = answerDiv.getAttribute('data-content') || '';
                    const newContent = currentContent + data.content;
                    answerDiv.setAttribute('data-content', newContent);
                    
                    // 预处理内容，确保列表格式正确
                    let processedContent = newContent;
                    
                    // 确保列表项有正确的换行，但避免处理参考来源部分
                    // 只处理不在参考来源部分的列表项
                    const beforeSources = processedContent.split('**📚 参考来源：**')[0];
                    const afterSources = processedContent.split('**📚 参考来源：**')[1] || '';
                    
                    // 只对主要内容部分进行列表处理，但保持数字列表的原始数字
                    let mainContent = beforeSources;
                    // 处理数字列表，确保换行但保持原始数字
                    mainContent = mainContent.replace(/(\d+\.\s+)/g, '\n$1');
                    // 处理无序列表，包括*符号，匹配任何位置的列表标记
                    mainContent = mainContent.replace(/([-•*]\s+)/g, '\n$1');
                    
                    // 重新组合内容
                    if (afterSources) {
                        processedContent = mainContent + '**📚 参考来源：**' + afterSources;
                    } else {
                        processedContent = mainContent;
                    }
                    
                    // 使用marked.js渲染markdown
                    const renderedContent = marked.parse(processedContent);
                    answerDiv.innerHTML = renderedContent;
                    
                    // 高亮代码块
                    answerDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightBlock(block);
                    });
                    
                    // 强制确保列表正确显示
                    answerDiv.querySelectorAll('ul, ol').forEach((list) => {
                        list.style.display = 'block';
                        list.style.paddingLeft = '2em';
                        list.style.marginBottom = '1em';
                        list.style.listStyleType = list.tagName === 'OL' ? 'decimal' : 'disc';
                        list.querySelectorAll('li').forEach((li) => {
                            li.style.display = 'list-item';
                            li.style.marginBottom = '0.5em';
                            li.style.lineHeight = '1.6';
                        });
                    });
                    
                    // 确保段落有正确的样式
                    answerDiv.querySelectorAll('p').forEach((p) => {
                        p.style.marginBottom = '1em';
                        p.style.lineHeight = '1.6';
                    });
                    
                    // 修复数字列表，保持原始数字
                    answerDiv.querySelectorAll('ol li').forEach((li, index) => {
                        // 检查li的文本内容是否以数字开头
                        const text = li.textContent;
                        const match = text.match(/^(\d+)\./);
                        if (match) {
                            const originalNumber = match[1];
                            // 移除开头的数字和点，保留其余内容
                            const content = text.replace(/^\d+\.\s*/, '');
                            li.innerHTML = `<span style="font-weight: bold; margin-right: 0.5em;">${originalNumber}.</span>${content}`;
                        }
                    });
                    
                    scrollToBottom();
                    break;
                    
                case 'complete':
                    // 完成后隐藏状态栏
                    statusDiv.style.display = 'none';
                    
                    // 移除答案区域的闪烁效果
                    answerDiv.classList.remove('typing-effect');
                    
                    // 显示置信度
                    const confidenceColor = data.confidence > 0.8 ? 'success' : data.confidence > 0.5 ? 'warning' : 'danger';
                    const messageDiv = document.getElementById(messageId);
                    const question = messageDiv.getAttribute('data-question') || '';
                    const answerContent = answerDiv.getAttribute('data-content') || answerDiv.textContent || '';
                    
                    confidenceDiv.innerHTML = `
                        <span class="badge bg-${confidenceColor}">
                            置信度: ${(data.confidence * 100).toFixed(1)}%
                        </span>
                        <span class="text-muted ms-2 small">
                            <i class="bi bi-clock"></i> ${data.timestamp || ''}
                        </span>
                        <button class="share-button ms-2" onclick="shareStreamConversation('${messageId}')" data-question="${question.replace(/"/g, '&quot;')}" data-answer="${answerContent.replace(/"/g, '&quot;')}" data-confidence="${data.confidence}">
                            <i class="bi bi-share"></i> 分享
                        </button>
                    `;
                    confidenceDiv.style.display = 'block';
                    
                    // 显示来源信息
                    if (sourcesDiv.innerHTML) {
                        sourcesDiv.style.display = 'block';
                    }
                    
                    scrollToBottom();
                    break;
                    
                case 'error':
                    statusDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2 text-danger"></i>
                            <strong>[错误]</strong> ❌ 错误: ${data.message}
                        </div>
                    `;
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    answerDiv.classList.remove('typing-effect');
                    break;
            }
        }
        
        // Clear chat
        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>
                    <p class="mt-3">欢迎使用智能笔记助手！<br>请在下方输入您的问题，我会基于您的读书笔记为您提供准确的回答。</p>
                </div>
            `;
            chatHistory = [];
        }
        
        // Toggle thinking process visibility
        function toggleThinking(element) {
            const thinkingDiv = element.parentElement.nextElementSibling;
            const icon = element.querySelector('i');
            
            if (thinkingDiv.style.display === 'none') {
                thinkingDiv.style.display = 'block';
                element.innerHTML = '<i class="bi bi-eye-slash"></i> 隐藏AI思考过程';
            } else {
                thinkingDiv.style.display = 'none';
                element.innerHTML = '<i class="bi bi-eye"></i> 查看AI思考过程';
            }
        }
        
        // Toggle thinking process for streaming mode
        function toggleThinkingProcess(messageId) {
            const thinkingDiv = document.getElementById(`${messageId}_thinking`);
            const button = event.target.closest('button'); // 获取触发事件的按钮
            
            if (thinkingDiv && thinkingDiv.style.display === 'none') {
                thinkingDiv.style.display = 'block';
                button.innerHTML = '<i class="bi bi-eye-slash"></i> 隐藏AI思考过程';
                button.className = 'btn btn-outline-primary btn-sm';
            } else if (thinkingDiv) {
                thinkingDiv.style.display = 'none';
                button.innerHTML = '<i class="bi bi-eye"></i> 查看AI思考过程';
                button.className = 'btn btn-outline-secondary btn-sm';
            }
        }
        
        // Scroll to bottom
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Run batch test
        async function runBatchTest() {
            const button = document.getElementById('runTestButton');
            const resultsDiv = document.getElementById('testResults');
            
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';
            
            resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">正在进行批量测试...</p></div>';
            
            try {
                const response = await fetch('/api/batch_test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayTestResults(data.results);
                } else {
                    resultsDiv.innerHTML = `<div class="error-message">测试失败: ${data.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-message">网络错误: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-play-circle"></i> 开始测试';
            }
        }
        
        // Display test results
        function displayTestResults(results) {
            const resultsDiv = document.getElementById('testResults');
            let html = `<h5><i class="bi bi-check-circle"></i> 测试完成 (${results.length} 个问题)</h5>`;
            
            results.forEach(result => {
                const confidenceColor = result.confidence > 0.8 ? 'success' : result.confidence > 0.5 ? 'warning' : 'danger';
                
                html += `
                    <div class="test-result">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6><i class="bi bi-question-circle"></i> ${result.question}</h6>
                            <span class="badge bg-${confidenceColor}">
                                ${(result.confidence * 100).toFixed(1)}%
                            </span>
                        </div>
                        <p class="text-muted mb-2">${result.error || result.answer}</p>
                        <small class="text-muted">
                            <i class="bi bi-book"></i> ${result.source_count} 个参考文档
                        </small>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Refresh status
        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateStatusDisplay(data);
            } catch (error) {
                console.error('获取状态失败:', error);
            }
        }
        
        // Update status display
        function updateStatusDisplay(data) {
            // System status
            const systemStatus = document.getElementById('systemStatus');
            if (data.system_ready && data.qa_ready) {
                systemStatus.innerHTML = '<span class="badge bg-success">系统正常</span>';
            } else if (data.system_ready) {
                systemStatus.innerHTML = '<span class="badge bg-warning">部分可用</span>';
            } else {
                systemStatus.innerHTML = '<span class="badge bg-danger">系统异常</span>';
            }
            
            // Document status
            const documentStatus = document.getElementById('documentStatus');
            if (data.document_count > 0) {
                documentStatus.innerHTML = `
                    <span class="badge bg-success">${data.document_count} 文档</span><br>
                    <small class="text-muted">${data.vector_size}维向量</small>
                `;
            } else {
                documentStatus.innerHTML = '<span class="badge bg-warning">无文档</span>';
            }
            
            // Model status
            const modelStatus = document.getElementById('modelStatus');
            if (data.qa_ready) {
                modelStatus.innerHTML = `
                    <span class="badge bg-success">模型就绪</span><br>
                    <small class="text-muted">${data.llm_model}</small>
                `;
            } else {
                modelStatus.innerHTML = '<span class="badge bg-danger">模型未就绪</span>';
            }
            
            // Detailed status
            const detailedStatus = document.getElementById('detailedStatus');
            detailedStatus.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-gear"></i> 系统信息</h6>
                        <ul class="list-unstyled">
                            <li><strong>系统状态:</strong> ${data.system_ready ? '✅ 正常' : '❌ 异常'}</li>
                            <li><strong>问答系统:</strong> ${data.qa_ready ? '✅ 就绪' : '❌ 未就绪'}</li>
                            <li><strong>最后初始化:</strong> ${data.last_init}</li>
                            ${data.error ? `<li><strong>错误:</strong> <span class="text-danger">${data.error}</span></li>` : ''}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-cpu"></i> 模型信息</h6>
                        <ul class="list-unstyled">
                            <li><strong>嵌入模型:</strong> ${data.embedding_model || 'N/A'}</li>
                            <li><strong>推理模型:</strong> ${data.llm_model || 'N/A'}</li>
                            <li><strong>文档数量:</strong> ${data.document_count || 0}</li>
                            <li><strong>缓存文件:</strong> ${data.cached_files || 0}</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // Reinitialize system
        async function reinitSystem() {
            if (!confirm('确定要重新初始化系统吗？这可能需要一些时间。')) {
                return;
            }
            
            const detailedStatus = document.getElementById('detailedStatus');
            detailedStatus.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">正在重新初始化系统...</p></div>';
            
            try {
                const response = await fetch('/api/init_system', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('系统重新初始化成功！');
                } else {
                    alert(`初始化失败: ${data.error}`);
                }
                
                refreshStatus();
            } catch (error) {
                alert(`网络错误: ${error.message}`);
                refreshStatus();
            }
        }
        
        // Share conversation functions
        function shareConversation(button) {
            const question = button.getAttribute('data-question');
            let answer = button.getAttribute('data-answer');
            const confidence = button.getAttribute('data-confidence');
            
            // 从DOM中获取已渲染的内容，保持原始格式
            const messageDiv = button.closest('.message');
            const markdownContentDiv = messageDiv.querySelector('.markdown-content');
            let renderedAnswerHTML = '';
            
            if (markdownContentDiv) {
                // 直接使用已渲染的HTML内容，保持原始格式
                renderedAnswerHTML = markdownContentDiv.innerHTML;
            } else {
                // 如果没有markdown内容，使用原始答案
                renderedAnswerHTML = answer.replace(/\n/g, '<br>');
            }
            
            // 获取思考过程
            const thinkingProcessDiv = messageDiv.querySelector('.thinking-process');
            let thinkingProcess = '';
            if (thinkingProcessDiv) {
                const thinkingContent = thinkingProcessDiv.textContent || thinkingProcessDiv.innerText || '';
                // 提取思考过程内容（去掉"AI思考过程："标签）
                thinkingProcess = thinkingContent.replace(/^AI思考过程：\s*/m, '').trim();
            }
            
            // 获取参考来源信息
            const sourcesDiv = messageDiv.querySelector('.sources-info');
            let sources = [];
            if (sourcesDiv) {
                const sourceText = sourcesDiv.textContent || sourcesDiv.innerText || '';
                // 解析参考来源文本，提取文件名和相似度
                const sourceLines = sourceText.split('\n').filter(line => line.trim().startsWith('•'));
                sources = sourceLines.map(line => {
                    const match = line.match(/•\s*(.+?)\s*\(相似度:\s*(\d+\.?\d*)%\)/);
                    if (match) {
                        return {
                            filename: match[1].trim(),
                            score: parseFloat(match[2]) / 100
                        };
                    }
                    return null;
                }).filter(source => source !== null);
            }
            
            generateSharePreviewFromHTML(question, renderedAnswerHTML, confidence, sources, thinkingProcess);
        }
        
        function shareStreamConversation(messageId) {
            const messageDiv = document.getElementById(messageId);
            const question = messageDiv.getAttribute('data-question');
            const answerDiv = document.getElementById(`${messageId}_answer`);
            const confidenceDiv = document.getElementById(`${messageId}_confidence`);
            
            // 直接获取已渲染的HTML内容，保持原始格式
            const renderedAnswerHTML = answerDiv.innerHTML;
            
            // 检查是否有思考过程
            const thinkingContentDiv = document.getElementById(`${messageId}_thinking_content`);
            let thinkingProcess = '';
            if (thinkingContentDiv && thinkingContentDiv.textContent.trim()) {
                thinkingProcess = thinkingContentDiv.textContent.trim();
            }
            
            // 从置信度区域提取置信度值
            const confidenceBadge = confidenceDiv.querySelector('.badge');
            const confidenceText = confidenceBadge ? confidenceBadge.textContent : '';
            const confidenceMatch = confidenceText.match(/(\d+\.?\d*)%/);
            const confidence = confidenceMatch ? parseFloat(confidenceMatch[1]) / 100 : 0;
            
            // 获取参考来源信息
            const sourcesDiv = document.getElementById(`${messageId}_sources`);
            let sources = [];
            if (sourcesDiv && sourcesDiv.style.display !== 'none') {
                const sourceText = sourcesDiv.textContent || sourcesDiv.innerText || '';
                // 解析参考来源文本，提取文件名和相似度
                const sourceLines = sourceText.split('\n').filter(line => line.trim().startsWith('•'));
                sources = sourceLines.map(line => {
                    const match = line.match(/•\s*(.+?)\s*\(相似度:\s*(\d+\.?\d*)%\)/);
                    if (match) {
                        return {
                            filename: match[1].trim(),
                            score: parseFloat(match[2]) / 100
                        };
                    }
                    return null;
                }).filter(source => source !== null);
            }
            
            generateSharePreviewFromHTML(question, renderedAnswerHTML, confidence, sources, thinkingProcess);
        }
        
        // Document management functions
        function handleFileSelection() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length > 0) {
                displaySelectedFiles(files);
            }
        }
        
        function displaySelectedFiles(files) {
            const uploadResults = document.getElementById('uploadResults');
            let html = '<div class="file-list"><h6>已选择的文件：</h6>';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const hasExtension = file.name.includes('.') && fileExtension !== file.name;
                
                // 文件类型图标
                let fileIcon = 'bi-file-earmark';
                if (hasExtension && fileExtension === 'txt') {
                    fileIcon = 'bi-file-earmark-text';
                } else if (!hasExtension) {
                    fileIcon = 'bi-file-earmark-text';  // 无扩展名的文件假设为文本文件
                } else {
                    fileIcon = 'bi-file-earmark';
                }
                
                // 文件类型提示
                let typeHint = '';
                if (!hasExtension) {
                    typeHint = '<small class="text-info ms-2">(无扩展名)</small>';
                } else if (fileExtension !== 'txt') {
                    typeHint = '<small class="text-warning ms-2">(非txt文件)</small>';
                }
                
                html += `
                    <div class="file-item">
                        <div>
                            <i class="${fileIcon} me-2"></i>
                            <strong>${file.name}</strong>
                            <small class="text-muted ms-2">(${fileSize})</small>
                            ${typeHint}
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="removeFile(${i})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
            }
            
            html += '</div>';
            uploadResults.innerHTML = html;
        }
        
        function removeFile(index) {
            const fileInput = document.getElementById('fileInput');
            const dt = new DataTransfer();
            const files = fileInput.files;
            
            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }
            
            fileInput.files = dt.files;
            
            if (fileInput.files.length > 0) {
                displaySelectedFiles(fileInput.files);
            } else {
                document.getElementById('uploadResults').innerHTML = '';
            }
        }
        
        function clearFileSelection() {
            document.getElementById('fileInput').value = '';
            document.getElementById('categoryInput').value = '';
            document.getElementById('uploadResults').innerHTML = '';
            document.getElementById('uploadProgress').style.display = 'none';
        }
        
        async function uploadDocuments() {
            const fileInput = document.getElementById('fileInput');
            const categoryInput = document.getElementById('categoryInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('请先选择要上传的文件');
                return;
            }
            
            const uploadButton = document.getElementById('uploadButton');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadStatus = document.getElementById('uploadStatus');
            const progressBar = document.getElementById('progressBar');
            
            uploadButton.disabled = true;
            uploadButton.innerHTML = '<i class="bi bi-hourglass-split"></i> 上传中...';
            uploadProgress.style.display = 'block';
            
            const formData = new FormData();
            const category = categoryInput.value.trim() || '未分类';
            
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            formData.append('category', category);
            
            try {
                const response = await fetch('/api/upload_documents', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    progressBar.style.width = '100%';
                    uploadStatus.innerHTML = `
                        <div class="success-message">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            成功上传 ${data.processed_files} 个文件，新增 ${data.new_documents} 个文档片段
                        </div>
                    `;
                    
                    // 清空文件选择
                    clearFileSelection();
                    
                    // 刷新文档列表
                    refreshDocumentList();
                    
                } else {
                    throw new Error(data.error || '上传失败');
                }
                
            } catch (error) {
                console.error('上传错误:', error);
                uploadStatus.innerHTML = `
                    <div class="error-message">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        上传失败: ${error.message}
                    </div>
                `;
            } finally {
                uploadButton.disabled = false;
                uploadButton.innerHTML = '<i class="bi bi-cloud-upload"></i> 开始上传';
                
                // 3秒后隐藏进度条
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                }, 3000);
            }
        }
        
        async function refreshDocumentList() {
            const documentList = document.getElementById('documentList');
            
            try {
                const response = await fetch('/api/document_list');
                const data = await response.json();
                
                if (data.success) {
                    displayDocumentList(data.documents);
                } else {
                    documentList.innerHTML = `
                        <div class="error-message">
                            获取文档列表失败: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('获取文档列表错误:', error);
                documentList.innerHTML = `
                    <div class="error-message">
                        网络错误: ${error.message}
                    </div>
                `;
            }
        }
        
        function displayDocumentList(documents) {
            const documentList = document.getElementById('documentList');
            
            if (documents.length === 0) {
                documentList.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-3">暂无已导入的文档<br>请上传txt文件开始使用</p>
                    </div>
                `;
                return;
            }
            
            // 按分类分组显示
            const categories = {};
            documents.forEach(doc => {
                const category = doc.category || '未分类';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(doc);
            });
            
            let html = '';
            Object.keys(categories).forEach(category => {
                const docs = categories[category];
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">
                            <i class="bi bi-folder"></i> ${category} 
                            <span class="badge bg-secondary ms-2">${docs.length}</span>
                        </h6>
                        <div class="row">
                `;
                
                docs.forEach(doc => {
                    const uploadTime = new Date(doc.upload_time).toLocaleString();
                    const fileSize = doc.file_size ? (doc.file_size / 1024).toFixed(1) + ' KB' : '未知';
                    
                    html += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="document-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">
                                        <i class="bi bi-file-earmark-text me-2"></i>
                                        ${doc.filename}
                                    </h6>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteDocument('${doc.filename}', '${category}')" title="删除文档">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="document-meta">
                                    <div><i class="bi bi-calendar3"></i> ${uploadTime}</div>
                                    <div><i class="bi bi-hdd"></i> ${fileSize}</div>
                                    <div><i class="bi bi-collection"></i> ${doc.chunks || 0} 个片段</div>
                                </div>
                                <span class="category-tag">${category}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            documentList.innerHTML = html;
        }
        
        async function deleteDocument(filename, category) {
            if (!confirm(`确定要删除文档 "${filename}" 吗？此操作不可撤销。`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete_document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename,
                        category: category
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('文档删除成功');
                    refreshDocumentList();
                } else {
                    alert(`删除失败: ${data.error}`);
                }
            } catch (error) {
                console.error('删除文档错误:', error);
                alert(`删除失败: ${error.message}`);
            }
        }
        
        function generateSharePreviewFromHTML(question, renderedAnswerHTML, confidence, sources = [], thinkingProcess = '') {
            const sharePreview = document.getElementById('sharePreview');
            const confidenceColor = confidence > 0.8 ? '#28a745' : confidence > 0.5 ? '#ffc107' : '#dc3545';
            const confidenceText = confidence > 0.8 ? '高' : confidence > 0.5 ? '中' : '低';
            
            // 清理问题内容中的HTML实体
            const cleanQuestion = question.replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
            
            // 构建分享内容，直接使用已渲染的HTML
            let shareContent = `
                <div class="header">
                    <h3>📚 智能笔记助手</h3>
                    <p style="margin: 0; color: #6c757d; font-size: 0.9em;">本地化读书笔记智能助手</p>
                </div>
                
                <div class="question">
                    <div class="question-label">
                        <i style="color: #2196f3;">❓</i>
                        <span>用户提问</span>
                    </div>
                    <div style="font-size: 1.1em; color: #333; line-height: 1.6;">${cleanQuestion}</div>
                </div>
                
                <div class="answer">
                    <div class="answer-label">
                        <i style="color: #28a745;">🤖</i>
                        <span>AI回答</span>
                        <span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">
                            置信度: ${confidenceText} (${(confidence * 100).toFixed(1)}%)
                        </span>
                    </div>
                    <div class="markdown-content" style="font-size: 1em; color: #333; line-height: 1.6;">${renderedAnswerHTML}</div>
                </div>
            `;
            
            // 如果有思考过程，也添加到分享内容中
            if (thinkingProcess) {
                shareContent += `
                    <div class="thinking-section" style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 15px;">
                        <div class="thinking-label" style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i style="color: #6f42c1;">🧠</i>
                            <span style="font-weight: 600; margin-left: 8px;">AI思考过程</span>
                        </div>
                        <div style="font-size: 0.9em; color: #555; background: #f8f9fa; padding: 12px; border-radius: 8px; white-space: pre-wrap; line-height: 1.5;">${thinkingProcess}</div>
                    </div>
                `;
            }
            
            // 如果有参考来源，也添加到分享内容中
            if (sources && sources.length > 0) {
                shareContent += `
                    <div class="sources-section" style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 15px;">
                        <div class="sources-label" style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i style="color: #2196f3;">📚</i>
                            <span style="font-weight: 600; margin-left: 8px;">参考来源 (${sources.length}个)</span>
                        </div>
                        <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; border-radius: 0 8px 8px 0; font-size: 0.9em; line-height: 1.5;">
                `;
                sources.forEach(source => {
                    shareContent += `• ${source.filename} (相似度: ${(source.score * 100).toFixed(1)}%)<br>`;
                });
                shareContent += `
                        </div>
                    </div>
                `;
            }
            
            shareContent += `
                <div class="footer">
                    <div style="color: #007bff; font-weight: 600;">基于读书笔记的智能问答系统</div>
                    <div style="margin-top: 4px;">${new Date().toLocaleString()}</div>
                </div>
            `;
            
            sharePreview.innerHTML = shareContent;
            
            // 显示模态框
            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
            shareModal.show();
        }
        
        function generateSharePreview(question, answer, confidence, sources = []) {
            const sharePreview = document.getElementById('sharePreview');
            const confidenceColor = confidence > 0.8 ? '#28a745' : confidence > 0.5 ? '#ffc107' : '#dc3545';
            const confidenceText = confidence > 0.8 ? '高' : confidence > 0.5 ? '中' : '低';
            
            // 清理问题内容中的HTML实体
            const cleanQuestion = question.replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
            
            // 处理答案内容
            let processedAnswer = answer;
            let thinkingProcess = '';
            
            // 首先解码HTML实体
            processedAnswer = processedAnswer.replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
            
            // 检查是否包含思考过程标签
            const thinkingMatch = processedAnswer.match(/<think>(.*?)<\/think>/s);
            if (thinkingMatch) {
                thinkingProcess = thinkingMatch[1].trim();
                // 移除思考过程标签，保留最终答案
                processedAnswer = processedAnswer.replace(/<think>.*?<\/think>/s, '').trim();
            }
            
            // 处理答案内容 - 如果包含HTML标签，说明是渲染后的内容，需要特殊处理
            if (processedAnswer.includes('<') && processedAnswer.includes('>')) {
                // 这是HTML内容，我们需要从中提取结构化的文本
                // 创建临时DOM来处理
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = processedAnswer;
                processedAnswer = extractMarkdownFromElement(tempDiv);
            }
            
            // 使用marked渲染markdown格式的答案
            const renderedAnswer = marked.parse(processedAnswer);
            
            // 构建分享内容
            let shareContent = `
                <div class="header">
                    <h3>📚 智能笔记助手</h3>
                    <p style="margin: 0; color: #6c757d; font-size: 0.9em;">本地化读书笔记智能助手</p>
                </div>
                
                <div class="question">
                    <div class="question-label">
                        <i style="color: #2196f3;">❓</i>
                        <span>用户提问</span>
                    </div>
                    <div style="font-size: 1.1em; color: #333; line-height: 1.6;">${cleanQuestion}</div>
                </div>
                
                <div class="answer">
                    <div class="answer-label">
                        <i style="color: #28a745;">🤖</i>
                        <span>AI回答</span>
                        <span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">
                            置信度: ${confidenceText} (${(confidence * 100).toFixed(1)}%)
                        </span>
                    </div>
                    <div class="markdown-content" style="font-size: 1em; color: #333; line-height: 1.6;">${renderedAnswer}</div>
                </div>
            `;
            
            // 如果有思考过程，也添加到分享内容中
            if (thinkingProcess) {
                shareContent += `
                    <div class="thinking-section" style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 15px;">
                        <div class="thinking-label" style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i style="color: #6f42c1;">🧠</i>
                            <span style="font-weight: 600; margin-left: 8px;">AI思考过程</span>
                        </div>
                        <div style="font-size: 0.9em; color: #555; background: #f8f9fa; padding: 12px; border-radius: 8px; white-space: pre-wrap; line-height: 1.5;">${thinkingProcess}</div>
                    </div>
                `;
            }
            
            // 如果有参考来源，也添加到分享内容中
            if (sources && sources.length > 0) {
                shareContent += `
                    <div class="sources-section" style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 15px;">
                        <div class="sources-label" style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i style="color: #2196f3;">📚</i>
                            <span style="font-weight: 600; margin-left: 8px;">参考来源 (${sources.length}个)</span>
                        </div>
                        <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; border-radius: 0 8px 8px 0; font-size: 0.9em; line-height: 1.5;">
                `;
                sources.forEach(source => {
                    shareContent += `• ${source.filename} (相似度: ${(source.score * 100).toFixed(1)}%)<br>`;
                });
                shareContent += `
                        </div>
                    </div>
                `;
            }
            
            shareContent += `
                <div class="footer">
                    <div style="color: #007bff; font-weight: 600;">基于读书笔记的智能问答系统</div>
                    <div style="margin-top: 4px;">${new Date().toLocaleString()}</div>
                </div>
            `;
            
            sharePreview.innerHTML = shareContent;
            
            // 显示模态框
            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
            shareModal.show();
        }
        
        // 从HTML元素提取Markdown格式文本的函数
        function extractMarkdownFromElement(element) {
            let markdown = '';
            
            for (let node of element.childNodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    markdown += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const tagName = node.tagName.toLowerCase();
                    switch (tagName) {
                        case 'p':
                            markdown += node.textContent + '\n\n';
                            break;
                        case 'br':
                            markdown += '\n';
                            break;
                        case 'strong':
                        case 'b':
                            markdown += `**${node.textContent}**`;
                            break;
                        case 'em':
                        case 'i':
                            markdown += `*${node.textContent}*`;
                            break;
                        case 'ul':
                            for (let li of node.querySelectorAll('li')) {
                                markdown += `- ${li.textContent}\n`;
                            }
                            markdown += '\n';
                            break;
                        case 'ol':
                            let counter = 1;
                            for (let li of node.querySelectorAll('li')) {
                                markdown += `${counter}. ${li.textContent}\n`;
                                counter++;
                            }
                            markdown += '\n';
                            break;
                        case 'h1': case 'h2': case 'h3': case 'h4': case 'h5': case 'h6':
                            const level = '#'.repeat(parseInt(tagName.charAt(1)));
                            markdown += `${level} ${node.textContent}\n\n`;
                            break;
                        case 'code':
                            if (node.parentNode.tagName.toLowerCase() !== 'pre') {
                                markdown += `\`${node.textContent}\``;
                            } else {
                                markdown += node.textContent;
                            }
                            break;
                        case 'pre':
                            markdown += '```\n' + node.textContent + '\n```\n\n';
                            break;
                        case 'blockquote':
                            const lines = node.textContent.split('\n');
                            for (let line of lines) {
                                if (line.trim()) {
                                    markdown += `> ${line}\n`;
                                }
                            }
                            markdown += '\n';
                            break;
                        default:
                            // 递归处理嵌套元素
                            markdown += extractMarkdownFromElement(node);
                            break;
                    }
                }
            }
            
            return markdown.replace(/\n{3,}/g, '\n\n').trim();
        }
        
        function downloadShareImage() {
            const sharePreview = document.getElementById('sharePreview');
            
            html2canvas(sharePreview, {
                backgroundColor: '#ffffff',
                scale: 2,
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                width: sharePreview.scrollWidth,
                height: sharePreview.scrollHeight
            }).then(canvas => {
                // 创建下载链接
                const link = document.createElement('a');
                link.download = `智能问答分享_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 关闭模态框
                const shareModal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
                shareModal.hide();
                
                // 显示成功提示
                alert('图片已保存到下载文件夹！');
            }).catch(error => {
                console.error('生成图片失败:', error);
                alert('生成图片失败，请重试。');
            });
        }
        
        // Keyword Search System JavaScript Functions
        let selectedKeywords = [];
        
        // Initialize keyword search system
        function initKeywordSearch() {
            // Load initial statistics
            loadKeywordStats();
            
            // Bind event listeners
            document.getElementById('keywordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchKeywords();
                }
            });
            
            document.getElementById('searchKeywordBtn').addEventListener('click', searchKeywords);
            document.getElementById('getSentencesBtn').addEventListener('click', getSentencesByKeywords);
            document.getElementById('refreshStatsBtn').addEventListener('click', loadKeywordStats);
            document.getElementById('rebuildKeywordIndexBtn').addEventListener('click', rebuildKeywordIndex);
        }
        
        // Search keywords function
        async function searchKeywords() {
            const input = document.getElementById('keywordInput');
            const query = input.value.trim();
            
            if (!query) {
                alert('请输入关键词');
                return;
            }
            
            const searchBtn = document.getElementById('searchKeywordBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 搜索中...';
            
            try {
                const response = await fetch('/api/keyword_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        query: query,
                        limit: 20
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayKeywordResults(data.keywords);
                } else {
                    alert(`搜索失败: ${data.error}`);
                }
            } catch (error) {
                console.error('关键词搜索错误:', error);
                alert(`网络错误: ${error.message}`);
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="bi bi-search"></i> 搜索';
            }
        }
        
        // Display keyword search results
        function displayKeywordResults(keywords) {
            const resultsDiv = document.getElementById('keywordResults');
            const listDiv = document.getElementById('keywordList');
            
            if (keywords.length === 0) {
                resultsDiv.style.display = 'none';
                alert('未找到匹配的关键词');
                return;
            }
            
            let html = '';
            keywords.forEach((keyword, index) => {
                // 确保 keyword 对象和 keyword.keyword 存在
                if (!keyword || !keyword.keyword) {
                    console.warn('Invalid keyword object:', keyword);
                    return;
                }
                
                const keywordText = keyword.keyword.toString();
                const isSelected = selectedKeywords.includes(keywordText);
                const badgeClass = isSelected ? 'bg-primary' : 'bg-light text-dark';
                const cursor = isSelected ? 'default' : 'pointer';
                
                html += `
                    <span class="badge ${badgeClass}" 
                          style="cursor: ${cursor}; font-size: 0.9em; margin: 2px; padding: 6px 10px;"
                          data-keyword-index="${index}"
                          onclick="${isSelected ? '' : `selectKeywordByIndex(${index})`}"
                          title="出现频次: ${keyword.count || 0}">
                        ${keywordText} (${keyword.count || 0})
                    </span>
                `;
            });
            
            listDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            // 存储关键词数据供点击事件使用
            window.currentKeywords = keywords;
        }
        
        // Select a keyword by index (safer approach)
        function selectKeywordByIndex(index) {
            if (window.currentKeywords && window.currentKeywords[index]) {
                const keyword = window.currentKeywords[index].keyword;
                if (keyword && !selectedKeywords.includes(keyword)) {
                    selectedKeywords.push(keyword);
                    updateSelectedKeywords();
                    
                    // Refresh keyword results to update selection status
                    displayKeywordResults(window.currentKeywords);
                }
            }
        }
        
        // Select a keyword
        function selectKeyword(keyword) {
            // 确保参数不为空且是字符串
            if (!keyword || typeof keyword !== 'string') {
                console.warn('Invalid keyword parameter:', keyword);
                return;
            }
            
            if (!selectedKeywords.includes(keyword)) {
                selectedKeywords.push(keyword);
                updateSelectedKeywords();
                
                // Refresh keyword results to update selection status
                const keywordInput = document.getElementById('keywordInput');
                if (keywordInput.value.trim()) {
                    searchKeywords();
                }
            }
        }
        
        // Update selected keywords display
        function updateSelectedKeywords() {
            const selectedDiv = document.getElementById('selectedKeywords');
            const listDiv = document.getElementById('selectedKeywordList');
            
            if (selectedKeywords.length === 0) {
                selectedDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            selectedKeywords.forEach((keyword, index) => {
                html += `
                    <span class="badge bg-success" 
                          style="font-size: 0.9em; margin: 2px; padding: 6px 10px; position: relative;">
                        ${keyword}
                        <button type="button" class="btn-close btn-close-white" 
                                style="font-size: 0.6em; margin-left: 6px;"
                                onclick="removeSelectedKeyword(${index})"
                                aria-label="Remove"></button>
                    </span>
                `;
            });
            
            listDiv.innerHTML = html;
            selectedDiv.style.display = 'block';
        }
        
        // Remove selected keyword
        function removeSelectedKeyword(index) {
            selectedKeywords.splice(index, 1);
            updateSelectedKeywords();
            
            // Clear sentences if no keywords selected
            if (selectedKeywords.length === 0) {
                clearKeywordSearchResults();
            }
        }
        
        // Get sentences by selected keywords
        async function getSentencesByKeywords() {
            if (selectedKeywords.length === 0) {
                alert('请先选择关键词');
                return;
            }
            
            const getSentencesBtn = document.getElementById('getSentencesBtn');
            getSentencesBtn.disabled = true;
            getSentencesBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 获取中...';
            
            try {
                const response = await fetch('/api/get_sentences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        keywords: selectedKeywords,
                        limit: 100
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displaySentences(data.sentences);
                } else {
                    alert(`获取句子失败: ${data.error}`);
                }
            } catch (error) {
                console.error('获取句子错误:', error);
                alert(`网络错误: ${error.message}`);
            } finally {
                getSentencesBtn.disabled = false;
                getSentencesBtn.innerHTML = '<i class="bi bi-list-ul"></i> 获取相关句子';
            }
        }
        
        // Display sentences
        function displaySentences(sentences) {
            const sectionsDiv = document.getElementById('sentencesSection');
            const listDiv = document.getElementById('sentencesList');
            const countSpan = document.getElementById('sentenceCount');
            
            if (sentences.length === 0) {
                sectionsDiv.style.display = 'none';
                alert('未找到包含所选关键词的句子');
                return;
            }
            
            countSpan.textContent = sentences.length;
            
            let html = `
                <div class="sentence-selection-header mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllKeyword" onchange="toggleAllKeywordSentences(this.checked)">
                            <label class="form-check-label" for="selectAllKeyword">
                                全选 (共 ${sentences.length} 条)
                            </label>
                        </div>
                        <div>
                            <span class="badge bg-info" id="keywordSelectedCount">已选: 0</span>
                            <button class="btn btn-sm btn-success ms-2" onclick="copySelectedKeywordSentences()" disabled id="copySelectedKeywordBtn">
                                <i class="bi bi-files"></i> 复制选中
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            sentences.forEach((sentence, index) => {
                // 安全处理句子数据
                const content = sentence.content || '';
                const filename = sentence.filename || '未知来源';
                const id = sentence.id || sentence.sentence_id || '';
                
                // Highlight keywords in the sentence
                let highlightedText = content;
                selectedKeywords.forEach(keyword => {
                    const regex = new RegExp(`(${keyword})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<mark class="bg-warning">$1</mark>');
                });
                
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                <div class="form-check me-3 mt-1">
                                    <input class="form-check-input keyword-sentence-check" type="checkbox" 
                                           id="keywordSentence-${index}" value="${index}" 
                                           onchange="updateKeywordSelection()">
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0 flex-grow-1">
                                            <i class="bi bi-file-earmark-text me-2"></i>
                                            ${filename}
                                        </h6>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-primary btn-sm copy-btn" id="keywordCopyBtn-${index}" 
                                                    onclick="console.log('关键词检索-句子复制按钮被点击'); copyKeywordSentence(${index})"
                                                    title="复制句子">
                                                <i class="bi bi-copy"></i> 句子
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm copy-btn" id="keywordCopyAllBtn-${index}" 
                                                    onclick="console.log('关键词检索-全部复制按钮被点击'); copyKeywordSentenceWithSource(${index})"
                                                    title="复制句子和来源">
                                                <i class="bi bi-clipboard"></i> 全部
                                            </button>
                                        </div>
                                    </div>
                                    <p class="card-text" style="line-height: 1.6; font-size: 0.95em;">
                                        ${highlightedText}
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-hash"></i> 句子ID: ${id}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            sectionsDiv.style.display = 'block';
            
            // Store sentences data for copy function
            window.currentKeywordSentences = sentences;
        }
        
        // 关键词检索模块 - 切换全选状态
        function toggleAllKeywordSentences(checked) {
            const checkboxes = document.querySelectorAll('.keyword-sentence-check');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
            updateKeywordSelection();
        }
        
        // 关键词检索模块 - 更新选择状态
        function updateKeywordSelection() {
            const checkboxes = document.querySelectorAll('.keyword-sentence-check');
            const checkedBoxes = document.querySelectorAll('.keyword-sentence-check:checked');
            const selectedCount = checkedBoxes.length;
            const totalCount = checkboxes.length;
            
            // 更新选中数量显示
            const countBadge = document.getElementById('keywordSelectedCount');
            if (countBadge) {
                countBadge.textContent = `已选: ${selectedCount}`;
            }
            
            // 更新复制按钮状态
            const copyBtn = document.getElementById('copySelectedKeywordBtn');
            if (copyBtn) {
                copyBtn.disabled = selectedCount === 0;
            }
            
            // 更新全选框状态
            const selectAllBox = document.getElementById('selectAllKeyword');
            if (selectAllBox) {
                if (selectedCount === 0) {
                    selectAllBox.indeterminate = false;
                    selectAllBox.checked = false;
                } else if (selectedCount === totalCount) {
                    selectAllBox.indeterminate = false;
                    selectAllBox.checked = true;
                } else {
                    selectAllBox.indeterminate = true;
                    selectAllBox.checked = false;
                }
            }
        }
        
        // 关键词检索模块 - 复制选中的句子
        function copySelectedKeywordSentences() {
            const checkedBoxes = document.querySelectorAll('.keyword-sentence-check:checked');
            
            if (checkedBoxes.length === 0) {
                showToast('请先选择要复制的句子', 'info');
                return;
            }
            
            const keywords = selectedKeywords.join(', ') || '未知关键词';
            let textToCopy = `关键词检索: ${keywords} (选中 ${checkedBoxes.length} 条)\n${'='.repeat(60)}\n\n`;
            
            checkedBoxes.forEach((checkbox, displayIndex) => {
                const index = parseInt(checkbox.value);
                const sentence = window.currentKeywordSentences[index];
                if (sentence) {
                    const content = sentence.content || '';
                    const filename = sentence.filename || '未知来源';
                    const id = sentence.id || sentence.sentence_id || '';
                    textToCopy += `${displayIndex + 1}. ${content}\n   —— 来源：${filename}\n   —— ID：${id}\n\n`;
                }
            });
            
            textToCopy += `\n已选择 ${checkedBoxes.length} 个句子`;
            
            copyToClipboard(textToCopy, 'keyword-selected-copy', `已复制 ${checkedBoxes.length} 个选中句子`);
        }
        
        // 关键词检索模块 - 复制单个句子
        function copyKeywordSentence(index) {
            console.log('copyKeywordSentence 被调用，index:', index);
            
            if (!window.currentKeywordSentences || !window.currentKeywordSentences[index]) {
                console.error('关键词检索句子数据不存在');
                showToast('数据错误：句子不存在', 'error');
                return;
            }
            
            const sentence = window.currentKeywordSentences[index];
            const content = sentence.content || '';
            console.log('准备复制关键词检索句子:', content.substring(0, 50) + '...');
            
            const textToCopy = content;
            copyToClipboard(textToCopy, `keywordCopyBtn-${index}`, '句子已复制');
        }
        
        // 关键词检索模块 - 复制句子和来源
        function copyKeywordSentenceWithSource(index) {
            console.log('copyKeywordSentenceWithSource 被调用，index:', index);
            
            if (!window.currentKeywordSentences || !window.currentKeywordSentences[index]) {
                console.error('关键词检索句子数据不存在');
                showToast('数据错误：句子不存在', 'error');
                return;
            }
            
            const sentence = window.currentKeywordSentences[index];
            const content = sentence.content || '';
            const filename = sentence.filename || '未知来源';
            console.log('准备复制关键词检索句子和来源:', content.substring(0, 30) + '...');
            
            const textToCopy = `${content}\n\n—— 来源：${filename}`;
            copyToClipboard(textToCopy, `keywordCopyAllBtn-${index}`, '句子和来源已复制');
        }
        
        // 关键词检索模块 - 批量复制所有句子
        function copyAllKeywordSentences() {
            console.log('copyAllKeywordSentences 被调用');
            
            if (!window.currentKeywordSentences || window.currentKeywordSentences.length === 0) {
                showToast('没有可复制的句子', 'info');
                return;
            }
            
            const keywords = selectedKeywords.join(', ') || '未知关键词';
            let textToCopy = `关键词检索: ${keywords}\n${'='.repeat(50)}\n\n`;
            
            window.currentKeywordSentences.forEach((sentence, index) => {
                textToCopy += `${index + 1}. ${sentence.content}\n   —— 来源：${sentence.filename}\n   —— ID：${sentence.id}\n\n`;
            });
            
            textToCopy += `\n总计 ${window.currentKeywordSentences.length} 个句子`;
            
            copyToClipboard(textToCopy, 'keyword-bulk-copy', `已复制 ${window.currentKeywordSentences.length} 个句子`);
        }
        
        // 关键词检索模块 - 关闭句子面板
        function closeSentencesSection() {
            console.log('closeSentencesSection 被调用');
            
            document.getElementById('sentencesSection').style.display = 'none';
            
            // 清空数据和选择状态
            window.currentKeywordSentences = null;
            
            // 重置选中状态
            selectedKeywords = [];
            
            // 更新按钮状态
            const getSentencesBtn = document.getElementById('getSentencesBtn');
            if (getSentencesBtn) {
                getSentencesBtn.innerHTML = '<i class="bi bi-list-ul"></i> 获取相关句子';
                getSentencesBtn.disabled = false;
            }
            
            showToast('已关闭句子面板', 'info');
        }
        
        // Load keyword statistics
        async function loadKeywordStats() {
            const statsDiv = document.getElementById('keywordStats');
            
            try {
                const response = await fetch('/api/keyword_stats');
                const data = await response.json();
                
                if (data.success) {
                    // 后端返回的是 data.statistics，不是 data.stats
                    displayKeywordStats(data.statistics || {});
                } else {
                    statsDiv.innerHTML = `
                        <div class="text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            加载统计失败: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载统计错误:', error);
                statsDiv.innerHTML = `
                    <div class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        网络错误: ${error.message}
                    </div>
                `;
            }
        }
        
        // Display keyword statistics
        function displayKeywordStats(stats) {
            const statsDiv = document.getElementById('keywordStats');
            
            // 计算平均关键词数
            const avgKeywords = stats.sentences > 0 ? (stats.keywords / stats.sentences).toFixed(1) : 0;
            
            const html = `
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h5 class="text-primary mb-1">${stats.sentences || 0}</h5>
                            <small class="text-muted">总句子数</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h5 class="text-success mb-1">${stats.keywords || 0}</h5>
                        <small class="text-muted">总关键词数</small>
                    </div>
                </div>
                <hr class="my-3">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h6 class="text-info mb-1">${stats.processed_files || 0}</h6>
                            <small class="text-muted">处理文件数</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-warning mb-1">${avgKeywords}</h6>
                        <small class="text-muted">平均关键词/句</small>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="bi bi-clock"></i> 
                        最后更新: ${new Date().toLocaleString()}
                    </small>
                </div>
            `;
            
            statsDiv.innerHTML = html;
        }
        
        // Rebuild keyword index
        async function rebuildKeywordIndex() {
            if (!confirm('确定要重建关键词索引吗？这可能需要一些时间。')) {
                return;
            }
            
            const rebuildBtn = document.getElementById('rebuildKeywordIndexBtn');
            rebuildBtn.disabled = true;
            rebuildBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 重建中...';
            
            try {
                const response = await fetch('/api/rebuild_keyword_index', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`索引重建成功！处理了 ${data.processed_files} 个文件，生成了 ${data.total_sentences} 个句子`);
                    
                    // Refresh statistics
                    loadKeywordStats();
                    
                    // Clear current search results
                    clearKeywordSearchResults();
                } else {
                    alert(`重建失败: ${data.error}`);
                }
            } catch (error) {
                console.error('重建索引错误:', error);
                alert(`网络错误: ${error.message}`);
            } finally {
                rebuildBtn.disabled = false;
                rebuildBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> 重建索引';
            }
        }
        
        // Clear keyword search results
        function clearKeywordSearchResults() {
            document.getElementById('keywordResults').style.display = 'none';
            document.getElementById('selectedKeywords').style.display = 'none';
            document.getElementById('sentencesSection').style.display = 'none';
            document.getElementById('keywordInput').value = '';
            selectedKeywords = [];
            window.currentSentences = null;
        }
        
        // Initialize keyword search when tab is activated
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize existing functions
            refreshStatus();
            refreshDocumentList();
            
            // Initialize keyword search system
            initKeywordSearch();
            
            // 检查复制功能支持情况
            checkCopySupport();
            
            // Tab switch event listener
            document.getElementById('keyword-tab').addEventListener('shown.bs.tab', function() {
                // Stop auto play when leaving random mode
                if (isAutoPlaying) {
                    stopAutoPlay();
                }
                // Load stats when keyword tab is shown
                loadKeywordStats();
            });
            
            // Roaming mode tab switch event listener
            document.getElementById('roaming-tab').addEventListener('shown.bs.tab', function() {
                // Stop auto play when leaving random mode
                if (isAutoPlaying) {
                    stopAutoPlay();
                }
                // Initialize roaming mode when tab is shown
                console.log('漫游模式标签页被激活');
                // Add a small delay to ensure Three.js is fully loaded
                setTimeout(() => {
                    initializeRoamingMode();
                }, 100);
            });
            
            // Books tab switch event listener
            document.getElementById('books-tab').addEventListener('shown.bs.tab', function() {
                // Stop auto play when leaving random mode
                if (isAutoPlaying) {
                    stopAutoPlay();
                }
                // Load book list when books tab is shown
                console.log('书籍浏览标签页被激活');
                refreshBookList();
            });
            
            // Random mode tab switch event listener  
            document.getElementById('random-tab').addEventListener('shown.bs.tab', function() {
                // Initialize random mode when tab is shown
                console.log('随机模式标签页被激活');
                setTimeout(() => {
                    initializeRandomMode();
                }, 100);
            });
            
            // Chat tab switch event listener
            document.getElementById('chat-tab').addEventListener('shown.bs.tab', function() {
                // Stop auto play when leaving random mode
                if (isAutoPlaying) {
                    stopAutoPlay();
                }
            });
            
            // Docs tab switch event listener
            document.getElementById('docs-tab').addEventListener('shown.bs.tab', function() {
                // Stop auto play when leaving random mode
                if (isAutoPlaying) {
                    stopAutoPlay();
                }
            });
        });

        // ==================== Books Browser Functions ====================
        
        // 重置书籍内容显示区域
        function resetBookContentArea() {
            const contentContainer = document.getElementById('bookContentContainer');
            const contentDiv = document.getElementById('bookContentText');
            const nameSpan = document.getElementById('bookContentName');
            const metaDiv = document.getElementById('bookContentMeta');
            const actionsDiv = document.getElementById('bookContentActions');
            
            // 显示占位符，隐藏内容区域
            contentContainer.style.display = 'flex';
            contentDiv.style.display = 'none';
            
            // 重置标题和隐藏元数据
            nameSpan.textContent = '请从左侧选择书籍';
            metaDiv.style.display = 'none';
            actionsDiv.style.display = 'none';
            
            // 清空当前书籍数据
            currentBookData = null;
        }
        
        // 全局变量存储当前书籍数据
        let currentBookData = null;
        
        // 刷新书籍列表
        async function refreshBookList() {
            const bookList = document.getElementById('bookList');
            
            // 重置内容区域
            resetBookContentArea();
            
            try {
                bookList.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span class="ms-2">加载中...</span>
                    </div>
                `;
                
                const response = await fetch('/api/book_list');
                const data = await response.json();
                
                if (data.success && data.books) {
                    displayBookList(data.books);
                } else {
                    bookList.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i>
                            <p class="mt-2">加载书籍列表失败</p>
                            <p class="text-danger small">${data.error || '未知错误'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('获取书籍列表错误:', error);
                bookList.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-wifi-off" style="font-size: 2rem;"></i>
                        <p class="mt-2">网络错误</p>
                        <p class="text-danger small">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 显示书籍列表
        function displayBookList(books) {
            const bookList = document.getElementById('bookList');
            
            if (books.length === 0) {
                bookList.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0 small">暂无书籍文件</p>
                        <p class="small mb-0">请确保notes目录中有笔记文件</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            books.forEach((book, index) => {
                const fileSize = book.file_size ? (book.file_size / 1024).toFixed(1) + ' KB' : '未知';
                const modifiedTime = book.modified_time ? 
                    new Date(book.modified_time).toLocaleDateString('zh-CN') : '未知';
                
                html += `
                    <div class="book-list-item" data-filename="${book.filename}" onclick="selectBook('${book.filename}', this)">
                        <div class="book-list-title">${book.book_name}</div>
                        <div class="book-list-meta">
                            <i class="bi bi-hdd"></i> ${fileSize} · 
                            <i class="bi bi-calendar3"></i> ${modifiedTime}
                        </div>
                    </div>
                `;
            });
            
            bookList.innerHTML = html;
        }
        
        // 选择书籍
        function selectBook(filename, element) {
            // 移除其他书籍的active状态
            document.querySelectorAll('.book-list-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 添加当前书籍的active状态
            element.classList.add('active');
            
            // 加载书籍内容
            loadBookContent(filename);
        }
        
        // 加载书籍内容
        async function loadBookContent(filename) {
            const contentContainer = document.getElementById('bookContentContainer');
            const contentDiv = document.getElementById('bookContentText');
            const nameSpan = document.getElementById('bookContentName');
            const sizeSpan = document.getElementById('bookFileSize');
            const lineSpan = document.getElementById('bookLineCount');
            const charSpan = document.getElementById('bookCharCount');
            const metaDiv = document.getElementById('bookContentMeta');
            const actionsDiv = document.getElementById('bookContentActions');
            
            try {
                // 隐藏占位符，显示内容区域，显示加载状态
                contentContainer.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-3">正在加载书籍内容...</p>
                    </div>
                `;
                
                const response = await fetch('/api/book_content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: filename })
                });
                
                const data = await response.json();
                
                if (data.success && data.book_info && data.content) {
                    currentBookData = data;
                    
                    console.log('书籍数据加载成功:', {
                        book_name: data.book_info.book_name,
                        content_length: data.content.length,
                        content_preview: data.content.substring(0, 100)
                    });
                    
                    // 更新书籍信息
                    nameSpan.textContent = data.book_info.book_name;
                    sizeSpan.textContent = ((data.book_info.file_size || 0) / 1024).toFixed(1) + ' KB';
                    lineSpan.textContent = (data.book_info.line_count || 0).toLocaleString();
                    charSpan.textContent = (data.book_info.char_count || 0).toLocaleString();
                    
                    // 显示元数据和操作按钮
                    metaDiv.style.display = 'block';
                    actionsDiv.style.display = 'flex';
                    
                    // 显示内容
                    contentDiv.textContent = data.content;
                    console.log('内容区域更新完成:', {
                        display: contentDiv.style.display,
                        content_set: contentDiv.textContent.length > 0
                    });
                } else {
                    contentDiv.innerHTML = `
                        <div class="text-center text-danger p-5">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                            <p class="mt-2">加载失败</p>
                            <p class="small">${data.error || '未知错误'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载书籍内容错误:', error);
                contentDiv.innerHTML = `
                    <div class="text-center text-danger p-5">
                        <i class="bi bi-wifi-off" style="font-size: 2rem;"></i>
                        <p class="mt-2">网络错误</p>
                        <p class="small">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 复制书籍内容
        function copyBookContent() {
            if (!currentBookData || !currentBookData.content) {
                showBookAlert('❌ 没有可复制的内容', 'warning');
                return;
            }
            
            const content = currentBookData.content;
            const bookName = currentBookData.book_info.book_name;
            
            // 准备复制的文本（包含书名）
            const textToCopy = `《${bookName}》\n\n${content}`;
            
            // 使用现有的复制函数，但创建一个简化版本用于书籍浏览
            copyBookToClipboard(textToCopy, bookName);
        }
        
        // 书籍专用的复制函数
        function copyBookToClipboard(text, bookName) {
            console.log('开始复制书籍内容:', bookName);
            
            // 优先使用现代API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('书籍内容复制成功');
                    showBookAlert('✅ 《' + bookName + '》内容已复制到剪贴板', 'success');
                }).catch(err => {
                    console.error('navigator.clipboard 复制失败:', err);
                    fallbackBookCopy(text, bookName);
                });
            } else {
                console.log('navigator.clipboard 不可用，使用降级方案');
                fallbackBookCopy(text, bookName);
            }
        }
        
        // 书籍复制的降级方案
        function fallbackBookCopy(text, bookName) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '-9999px';
                textArea.style.width = '1px';
                textArea.style.height = '1px';
                textArea.style.opacity = '0';
                textArea.setAttribute('readonly', '');
                textArea.setAttribute('contenteditable', 'true');
                document.body.appendChild(textArea);
                
                // 选中文本
                textArea.select();
                textArea.setSelectionRange(0, text.length);
                
                // 尝试复制
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    console.log('降级方案复制成功');
                    showBookAlert('✅ 《' + bookName + '》内容已复制到剪贴板', 'success');
                } else {
                    throw new Error('document.execCommand 返回 false');
                }
            } catch (fallbackErr) {
                console.error('所有复制方案都失败:', fallbackErr);
                showBookAlert('❌ 复制失败，请手动选择文本复制', 'danger');
            }
        }
        
        // 关闭书籍内容
        function closeBookContent() {
            document.getElementById('bookContentSection').style.display = 'none';
            currentBookData = null;
        }
        
        // 显示书籍相关的提示信息
        function showBookAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 自动移除
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
        
        // ==================== Roaming Mode 3D Visualization ====================
        
        let roamingScene, roamingCamera, roamingRenderer, roamingControls;
        let keywordSpheres = [];
        let selectedKeyword = null;
        let isRotating = true;
        let animationId;
        
        // Helper function to show alerts
        function showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
        
        function initializeRoamingMode() {
            console.log('初始化漫游模式...');
            
            // Show loading indicator
            const loadingElement = document.getElementById('roamingLoading');
            if (loadingElement) {
                loadingElement.style.display = 'block';
                console.log('显示加载指示器');
            } else {
                console.error('找不到加载指示器元素');
            }
            
            // Load top keywords
            console.log('开始获取关键词...');
            fetch('/api/top_keywords?limit=50')
                .then(response => {
                    console.log('API响应状态:', response.status);
                    return response.json();
                })
                .then(async data => {
                    console.log('API响应数据:', data);
                    if (data.success) {
                        console.log('成功获取到', data.keywords.length, '个关键词');
                        await setup3DVisualization(data.keywords);
                    } else {
                        console.error('Failed to load keywords:', data.error);
                        showAlert('加载关键词失败: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading keywords:', error);
                    showAlert('加载关键词时发生错误: ' + error.message, 'danger');
                })
                .finally(() => {
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                        console.log('隐藏加载指示器');
                    }
                });
        }
        
        async function setup3DVisualization(keywords) {
            console.log('开始设置3D可视化，关键词数量:', keywords.length);
            
            const container = document.getElementById('threejsContainer');
            const canvas = document.getElementById('threejsCanvas');
            
            if (!container) {
                console.error('找不到3D容器元素');
                return;
            }
            if (!canvas) {
                console.error('找不到canvas元素');
                return;
            }
            
            console.log('容器尺寸:', container.clientWidth, 'x', container.clientHeight);
            
            // Check if Three.js is loaded
            if (typeof THREE === 'undefined') {
                console.error('Three.js library not loaded');
                showAlert('Three.js库未加载，请刷新页面重试', 'danger');
                return;
            }
            
            console.log('Three.js版本:', THREE.REVISION);
            
            // Clear previous scene if exists
            if (roamingRenderer) {
                console.log('清理之前的渲染器');
                roamingRenderer.dispose();
            }
            
            // Scene setup
            console.log('创建场景...');
            roamingScene = new THREE.Scene();
            roamingScene.background = new THREE.Color(0xffffff);  // 白色背景
            
            // Load font for 3D text
            console.log('加载字体...');
            const fontLoader = new THREE.FontLoader();
            
            // Camera setup
            console.log('创建相机...');
            roamingCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            roamingCamera.position.z = 15;
            
            // Renderer setup
            console.log('创建渲染器...');
            roamingRenderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            roamingRenderer.setSize(container.clientWidth, container.clientHeight);
            roamingRenderer.shadowMap.enabled = true;
            roamingRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Controls setup
            console.log('创建控制器...');
            if (typeof THREE.OrbitControls === 'undefined') {
                console.error('OrbitControls not loaded');
                showAlert('OrbitControls库未加载，请刷新页面重试', 'danger');
                return;
            }
            
            roamingControls = new THREE.OrbitControls(roamingCamera, roamingRenderer.domElement);
            roamingControls.enableDamping = true;
            roamingControls.dampingFactor = 0.05;
            roamingControls.maxDistance = 30;
            roamingControls.minDistance = 5;
            
            // Lighting
            console.log('添加光照...');
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            roamingScene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            roamingScene.add(directionalLight);
            
            // Create keyword spheres (async)
            console.log('创建3D关键词文字...');
            try {
                await createKeywordSpheres(keywords);
                
                // Mouse interaction
                console.log('设置鼠标交互...');
                setupMouseInteraction();
                
                // Start animation
                console.log('开始动画循环...');
                animate3D();
                
                // Handle window resize
                window.addEventListener('resize', onWindowResize);
                
                console.log('3D可视化设置完成');
            } catch (error) {
                console.error('创建3D文字失败:', error);
            }
        }
        
        async function createKeywordSpheres(keywords) {
            console.log('开始创建', keywords.length, '个3D关键词文本');
            keywordSpheres = [];
            
            return new Promise((resolve, reject) => {
                // 由于中文字体文件较大，我们回退到使用Canvas纹理方案，但保持3D几何体
                console.log('使用Canvas纹理创建中文3D文字');
                
                // Calculate text positions on a sphere surface
                const radius = 7; // 减小半径让关键词更紧凑
                
                keywords.forEach((keyword, index) => {
                    console.log(`创建第${index + 1}个3D关键词: ${keyword.word} (频率: ${keyword.frequency})`);
                    
                    // Spherical coordinates for even distribution
                    const phi = Math.acos(-1 + (2 * index) / keywords.length);
                    const theta = Math.sqrt(keywords.length * Math.PI) * phi;
                    
                    const x = radius * Math.cos(theta) * Math.sin(phi);
                    const y = radius * Math.sin(theta) * Math.sin(phi);
                    const z = radius * Math.cos(phi);
                    
                    // Calculate text size based on frequency
                    const maxFreq = keywords[0].frequency;
                    const minFreq = keywords[keywords.length - 1].frequency;
                    const normalizedFreq = (keyword.frequency - minFreq) / (maxFreq - minFreq);
                    const scaledFreq = Math.sqrt(normalizedFreq);
                    
                    // Canvas文字大小范围
                    const minFontSize = 36;
                    const maxFontSize = 72;
                    const fontSize = minFontSize + scaledFreq * (maxFontSize - minFontSize);
                    
                    // 使用预定义的鲜艳颜色调色板
                    const vibrantColors = [
                        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                        '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
                        '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#D2B4DE',
                        '#7FB3D3', '#F9E79F', '#A8E6CF', '#FFB347', '#87CEEB',
                        '#FF8A80', '#A7FFEB', '#84FFFF', '#B9F6CA', '#FFECB3'
                    ];
                    
                    // 根据索引循环选择颜色
                    const selectedColor = vibrantColors[index % vibrantColors.length];
                    const color = new THREE.Color(selectedColor);
                    
                    // Create high-quality canvas texture for Chinese text
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = 512;
                    canvas.height = 128;
                    
                    // 设置透明背景
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // 绘制高质量中文文字
                    context.fillStyle = selectedColor;
                    context.font = `bold ${Math.floor(fontSize)}px "Microsoft YaHei", "SimHei", Arial, sans-serif`;
                    context.textAlign = 'center';
                    context.textBaseline = 'middle';
                    
                    // 使用深色描边提高可读性（对于亮色文字使用深色描边）
                    context.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                    context.lineWidth = 2;
                    context.strokeText(keyword.word, canvas.width / 2, canvas.height / 2);
                    context.fillText(keyword.word, canvas.width / 2, canvas.height / 2);
                    
                    // Create texture
                    const texture = new THREE.CanvasTexture(canvas);
                    texture.generateMipmaps = false;
                    texture.minFilter = THREE.LinearFilter;
                    texture.magFilter = THREE.LinearFilter;
                    
                    // 创建3D立体几何体（使用BoxGeometry模拟3D文字效果）
                    const textWidth = 3 + scaledFreq * 2; // 根据频率调整宽度
                    const textHeight = 0.8;
                    const textDepth = 0.2 + scaledFreq * 0.3; // 根据频率调整厚度
                    
                    const geometry = new THREE.BoxGeometry(textWidth, textHeight, textDepth);
                    
                    // 创建材质数组，让正面显示文字，其他面显示纯色
                    const materials = [
                        new THREE.MeshPhongMaterial({ color: color }), // 右面
                        new THREE.MeshPhongMaterial({ color: color }), // 左面
                        new THREE.MeshPhongMaterial({ color: color }), // 上面
                        new THREE.MeshPhongMaterial({ color: color }), // 下面
                        new THREE.MeshPhongMaterial({ // 正面 - 显示文字
                            map: texture, 
                            transparent: true,
                            alphaTest: 0.1
                        }), 
                        new THREE.MeshPhongMaterial({ color: color })  // 背面
                    ];
                    
                    // Create mesh
                    const textMesh = new THREE.Mesh(geometry, materials);
                    textMesh.position.set(x, y, z);
                    textMesh.lookAt(roamingCamera.position); // 初始朝向相机
                    
                    // Store keyword data
                    textMesh.userData = {
                        keyword: keyword.word,
                        frequency: keyword.frequency,
                        originalColor: color,
                        originalScale: 1.0
                    };
                    
                    roamingScene.add(textMesh);
                    keywordSpheres.push(textMesh);
                });
                
                console.log('成功创建了', keywordSpheres.length, '个3D中文关键词');
                resolve();
            });
        }
        
        function setupMouseInteraction() {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            function onMouseClick(event) {
                const container = document.getElementById('threejsContainer');
                const rect = container.getBoundingClientRect();
                
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, roamingCamera);
                const intersects = raycaster.intersectObjects(keywordSpheres);
                
                if (intersects.length > 0) {
                    const clickedTextMesh = intersects[0].object;
                    handleKeywordClick(clickedTextMesh);
                }
            }
            
            roamingRenderer.domElement.addEventListener('click', onMouseClick);
        }
        
        function handleKeywordClick(textMesh) {
            if (selectedKeyword === textMesh) {
                // Deselect current keyword
                deselectKeyword();
            } else {
                // Select new keyword
                selectKeyword(textMesh);
            }
        }
        
        function selectKeyword(textMesh) {
            // Deselect previous keyword
            if (selectedKeyword) {
                deselectKeyword();
            }
            
            selectedKeyword = textMesh;
            window.selectedKeywordMesh = textMesh; // 保存到全局变量
            
            // Visual feedback - change scale and add outline effect
            textMesh.scale.setScalar(1.3);
            
            // Stop rotation
            isRotating = false;
            updateRotationStatus();
            
            // Load and display sentences
            loadKeywordSentences(textMesh.userData.keyword, textMesh.userData.frequency);
        }
        
        function deselectKeyword() {
            if (selectedKeyword) {
                // Restore original scale
                selectedKeyword.scale.setScalar(1.0);
                selectedKeyword = null;
                window.selectedKeywordMesh = null; // 清空全局变量
            }
            
            // Resume rotation
            isRotating = true;
            updateRotationStatus();
            
            // Hide sentences panel
            document.getElementById('selectedKeywordInfo').style.display = 'none';
            
            // 清空数据
            window.currentSentences = null;
        }
        
        function updateRotationStatus() {
            const statusElement = document.getElementById('rotationStatus');
            if (isRotating) {
                statusElement.textContent = '🔄 自动旋转中';
                statusElement.classList.remove('paused');
            } else {
                statusElement.textContent = '⏸️ 已暂停';
                statusElement.classList.add('paused');
            }
        }
        
        function loadKeywordSentences(keyword, frequency) {
            console.log('加载关键词句子:', keyword);
            
            // Show keyword info panel
            document.getElementById('selectedKeywordName').textContent = keyword;
            document.getElementById('selectedKeywordCount').textContent = frequency;
            document.getElementById('selectedKeywordInfo').style.display = 'block';
            
            // Show loading in sentences area
            document.getElementById('selectedKeywordSentences').innerHTML = 
                '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> 加载中...</div>';
            
            // Load sentences using get_sentences API
            fetch('/api/get_sentences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keywords: [keyword]
                })
            })
            .then(response => {
                console.log('句子API响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('句子API响应数据:', data);
                if (data.success && data.sentences) {
                    displayKeywordSentences(data.sentences);
                } else {
                    document.getElementById('selectedKeywordSentences').innerHTML = 
                        '<p class="text-muted">暂无相关句子</p>';
                }
            })
            .catch(error => {
                console.error('Error loading sentences:', error);
                document.getElementById('selectedKeywordSentences').innerHTML = 
                    '<p class="text-danger">加载句子时发生错误: ' + error.message + '</p>';
            });
        }
        
        function displayKeywordSentences(sentences) {
            const container = document.getElementById('selectedKeywordSentences');
            
            if (sentences.length === 0) {
                container.innerHTML = '<p class="text-muted">暂无相关句子</p>';
                return;
            }
            
            let html = `
                <div class="sentence-selection-header mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllRoaming" onchange="toggleAllRoamingSentences(this.checked)">
                            <label class="form-check-label" for="selectAllRoaming">
                                全选 (共 ${sentences.length} 条)
                            </label>
                        </div>
                        <div>
                            <span class="badge bg-info" id="roamingSelectedCount">已选: 0</span>
                            <button class="btn btn-sm btn-success ms-2" onclick="copySelectedRoamingSentences()" disabled id="copySelectedRoamingBtn">
                                <i class="bi bi-files"></i> 复制选中
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            sentences.forEach((sentence, index) => {
                html += `
                    <div class="sentence-item">
                        <div class="d-flex align-items-start">
                            <div class="form-check me-3 mt-1">
                                <input class="form-check-input roaming-sentence-check" type="checkbox" 
                                       id="roamingSentence-${index}" value="${index}" 
                                       onchange="updateRoamingSelection()">
                            </div>
                            <div class="flex-grow-1">
                                <div class="sentence-text">${sentence.content}</div>
                                <div class="sentence-source">
                                    <div>
                                        <i class="bi bi-file-text"></i> ${sentence.filename}
                                    </div>
                                    <div class="copy-actions">
                                        <button class="copy-btn" id="copyBtn-${index}" onclick="console.log('单句复制按钮被点击'); copySentence(${index})" title="复制句子">
                                            <i class="bi bi-copy"></i> 句子
                                        </button>
                                        <button class="copy-btn" id="copyAllBtn-${index}" onclick="console.log('全部复制按钮被点击'); copySentenceWithSource(${index})" title="复制句子和来源">
                                            <i class="bi bi-clipboard"></i> 全部
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 保存句子数据以供复制函数使用
            window.currentSentences = sentences;
        }
        
        // 漫游模式 - 切换全选状态
        function toggleAllRoamingSentences(checked) {
            const checkboxes = document.querySelectorAll('.roaming-sentence-check');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
            updateRoamingSelection();
        }
        
        // 漫游模式 - 更新选择状态
        function updateRoamingSelection() {
            const checkboxes = document.querySelectorAll('.roaming-sentence-check');
            const checkedBoxes = document.querySelectorAll('.roaming-sentence-check:checked');
            const selectedCount = checkedBoxes.length;
            const totalCount = checkboxes.length;
            
            // 更新选中数量显示
            const countBadge = document.getElementById('roamingSelectedCount');
            if (countBadge) {
                countBadge.textContent = `已选: ${selectedCount}`;
            }
            
            // 更新复制按钮状态
            const copyBtn = document.getElementById('copySelectedRoamingBtn');
            if (copyBtn) {
                copyBtn.disabled = selectedCount === 0;
            }
            
            // 更新全选框状态
            const selectAllBox = document.getElementById('selectAllRoaming');
            if (selectAllBox) {
                if (selectedCount === 0) {
                    selectAllBox.indeterminate = false;
                    selectAllBox.checked = false;
                } else if (selectedCount === totalCount) {
                    selectAllBox.indeterminate = false;
                    selectAllBox.checked = true;
                } else {
                    selectAllBox.indeterminate = true;
                    selectAllBox.checked = false;
                }
            }
        }
        
        // 漫游模式 - 复制选中的句子
        function copySelectedRoamingSentences() {
            const checkedBoxes = document.querySelectorAll('.roaming-sentence-check:checked');
            
            if (checkedBoxes.length === 0) {
                showToast('请先选择要复制的句子', 'info');
                return;
            }
            
            const keywordName = document.getElementById('selectedKeywordName').textContent || '未知关键词';
            let textToCopy = `关键词: ${keywordName} (选中 ${checkedBoxes.length} 条)\n${'='.repeat(50)}\n\n`;
            
            checkedBoxes.forEach((checkbox, displayIndex) => {
                const index = parseInt(checkbox.value);
                const sentence = window.currentSentences[index];
                if (sentence) {
                    textToCopy += `${displayIndex + 1}. ${sentence.content}\n   —— 来源：${sentence.filename}\n\n`;
                }
            });
            
            textToCopy += `\n已选择 ${checkedBoxes.length} 个句子`;
            
            copyToClipboard(textToCopy, 'roaming-selected-copy', `已复制 ${checkedBoxes.length} 个选中句子`);
        }
        
        // 复制单个句子
        function copySentence(index) {
            console.log('copySentence 被调用，index:', index);
            
            if (!window.currentSentences || !window.currentSentences[index]) {
                console.error('句子数据不存在');
                showToast('数据错误：句子不存在', 'error');
                return;
            }
            
            const sentence = window.currentSentences[index];
            console.log('准备复制句子:', sentence.content.substring(0, 50) + '...');
            
            const textToCopy = sentence.content;
            copyToClipboard(textToCopy, `copyBtn-${index}`, '句子已复制');
        }
        
        // 复制句子和来源
        function copySentenceWithSource(index) {
            console.log('copySentenceWithSource 被调用，index:', index);
            
            if (!window.currentSentences || !window.currentSentences[index]) {
                console.error('句子数据不存在');
                showToast('数据错误：句子不存在', 'error');
                return;
            }
            
            const sentence = window.currentSentences[index];
            console.log('准备复制句子和来源:', sentence.content.substring(0, 30) + '...');
            
            const textToCopy = `${sentence.content}\n\n—— 来源：${sentence.filename}`;
            copyToClipboard(textToCopy, `copyAllBtn-${index}`, '句子和来源已复制');
        }
        
        // 通用复制到剪贴板函数
        function copyToClipboard(text, buttonId, successMessage) {
            console.log('开始复制:', text.substring(0, 50) + '...');
            
            // 优先使用现代API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('使用 navigator.clipboard 复制成功');
                    showCopySuccess(buttonId, successMessage);
                }).catch(err => {
                    console.error('navigator.clipboard 复制失败:', err);
                    fallbackCopy(text, buttonId, successMessage);
                });
            } else {
                console.log('navigator.clipboard 不可用，使用降级方案');
                fallbackCopy(text, buttonId, successMessage);
            }
        }
        
        // 降级复制方案
        function fallbackCopy(text, buttonId, successMessage) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '-9999px';
                textArea.style.width = '1px';
                textArea.style.height = '1px';
                textArea.style.opacity = '0';
                textArea.setAttribute('readonly', '');
                textArea.setAttribute('contenteditable', 'true');
                document.body.appendChild(textArea);
                
                // 选中文本
                textArea.select();
                textArea.setSelectionRange(0, text.length);
                
                // 尝试复制
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    console.log('降级方案复制成功');
                    showCopySuccess(buttonId, successMessage);
                } else {
                    throw new Error('document.execCommand 返回 false');
                }
            } catch (fallbackErr) {
                console.error('所有复制方案都失败:', fallbackErr);
                // 最后的手动提示方案
                showCopyError(text, buttonId);
            }
        }
        
        // 显示复制失败的提示
        function showCopyError(text, buttonId) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 80%;
                max-height: 80%;
                overflow: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h5>复制失败，请手动复制以下内容：</h5>
                <textarea readonly style="width: 100%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">${text}</textarea>
                <div style="text-align: right;">
                    <button onclick="this.closest('.copy-error-modal').remove()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">关闭</button>
                </div>
            `;
            
            modal.className = 'copy-error-modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // 显示复制成功的视觉反馈
        function showCopySuccess(buttonId, message) {
            // 找到对应的按钮并改变样式
            const button = document.getElementById(buttonId);
            if (button) {
                const originalText = button.innerHTML;
                const originalClass = button.className;
                
                button.className = originalClass + ' copied';
                button.innerHTML = '<i class="bi bi-check"></i> 已复制';
                
                // 2秒后恢复原样
                setTimeout(() => {
                    if (document.getElementById(buttonId)) {
                        button.className = originalClass;
                        button.innerHTML = originalText;
                    }
                }, 2000);
            }
            
            // 显示Toast提示
            showToast(message, 'success');
        }
        
        // Toast提示函数
        function showToast(message, type = 'info') {
            console.log('显示Toast:', message, type);
            
            // 创建toast元素
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff';
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-size: 14px;
                transform: translateX(300px);
                transition: transform 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 动画显示
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // 3秒后自动消失（错误消息5秒）
            const duration = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                toast.style.transform = 'translateX(300px)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        // 键盘快捷键支持
        document.addEventListener('keydown', function(event) {
            // 检查是否按下了 Ctrl+C (Windows/Linux) 或 Cmd+C (Mac)
            const isCopyShortcut = (event.ctrlKey || event.metaKey) && event.key === 'c';
            
            if (isCopyShortcut) {
                // 优先检查漫游模式的句子
                if (window.currentSentences && window.currentSentences.length > 0) {
                    event.preventDefault();
                    
                    // 检查是否有选中的句子
                    const selectedRoaming = document.querySelectorAll('.roaming-sentence-check:checked');
                    if (selectedRoaming.length > 0) {
                        copySelectedRoamingSentences();
                    } else {
                        copyAllSentences();
                    }
                    return;
                }
                
                // 然后检查关键词检索的句子
                if (window.currentKeywordSentences && window.currentKeywordSentences.length > 0) {
                    event.preventDefault();
                    
                    // 检查是否有选中的句子
                    const selectedKeyword = document.querySelectorAll('.keyword-sentence-check:checked');
                    if (selectedKeyword.length > 0) {
                        copySelectedKeywordSentences();
                    } else {
                        copyAllKeywordSentences();
                    }
                    return;
                }
            }
        });
        
        // 复制当前选中关键词的所有句子
        function copyAllSentences() {
            if (!window.currentSentences || window.currentSentences.length === 0) {
                showToast('没有可复制的句子', 'info');
                return;
            }
            
            const keywordName = document.getElementById('selectedKeywordName').textContent || '未知关键词';
            let textToCopy = `关键词: ${keywordName}\n${'='.repeat(30)}\n\n`;
            
            window.currentSentences.forEach((sentence, index) => {
                textToCopy += `${index + 1}. ${sentence.content}\n   —— 来源：${sentence.filename}\n\n`;
            });
            
            textToCopy += `\n总计 ${window.currentSentences.length} 个句子`;
            
            copyToClipboard(textToCopy, 'bulk-copy', `已复制 ${window.currentSentences.length} 个句子`);
        }
        
        // 关闭关键词信息面板
        function closeKeywordInfo() {
            document.getElementById('selectedKeywordInfo').style.display = 'none';
            
            // 重置3D场景中的选中状态
            if (window.selectedKeywordMesh) {
                window.selectedKeywordMesh.scale.set(1, 1, 1);
                window.selectedKeywordMesh = null;
            }
            
            // 清空数据和选择状态
            window.currentSentences = null;
            
            showToast('已关闭关键词面板', 'info');
        }
        
        // 检查复制功能是否可用
        function checkCopySupport() {
            console.log('检查复制功能支持情况:');
            console.log('- navigator.clipboard:', !!navigator.clipboard);
            console.log('- navigator.clipboard.writeText:', !!(navigator.clipboard && navigator.clipboard.writeText));
            console.log('- document.execCommand:', !!document.execCommand);
            console.log('- 当前协议:', window.location.protocol);
            console.log('- 是否HTTPS:', window.location.protocol === 'https:');
            console.log('- 是否localhost:', window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
            
            // 测试复制功能
            const testText = 'test';
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(testText).then(() => {
                    console.log('✅ navigator.clipboard 测试成功');
                }).catch(err => {
                    console.log('❌ navigator.clipboard 测试失败:', err);
                });
            }
        }
        
        function animate3D() {
            animationId = requestAnimationFrame(animate3D);
            
            // Auto rotation
            if (isRotating) {
                // Rotate entire scene slowly
                roamingScene.rotation.y += 0.002;  // 更慢的旋转速度
            }
            
            // Keep text faces towards camera with subtle rotation
            keywordSpheres.forEach((textMesh, index) => {
                // 主要保持朝向相机，但添加轻微的摆动效果
                const time = Date.now() * 0.001;
                const baseRotation = new THREE.Vector3().copy(roamingCamera.position).sub(textMesh.position);
                textMesh.lookAt(roamingCamera.position);
                
                // 添加轻微的Y轴摆动让3D效果更明显
                textMesh.rotation.y += Math.sin(time + index) * 0.001;
                textMesh.rotation.x += Math.cos(time + index * 0.5) * 0.0005;
            });
            
            roamingControls.update();
            roamingRenderer.render(roamingScene, roamingCamera);
        }
        
        function onWindowResize() {
            const container = document.getElementById('threejsContainer');
            if (container && roamingCamera && roamingRenderer) {
                roamingCamera.aspect = container.clientWidth / container.clientHeight;
                roamingCamera.updateProjectionMatrix();
                roamingRenderer.setSize(container.clientWidth, container.clientHeight);
            }
        }

        // 随机模式相关变量和函数
        let randomQuotes = [];
        let currentRandomQuote = null;
        let randomSessionCount = 0;
        let recentQuotes = [];
        const maxRecentQuotes = 20;
        let autoPlayInterval = null;
        let isAutoPlaying = false;
        let autoPlaySpeed = 0.5; // 默认0.5秒间隔
        let currentBackgroundIndex = 1; // 当前背景索引
        
        // 书籍筛选相关变量
        let allBooks = [];
        let selectedBooks = [];
        let filteredBooks = []; // 搜索筛选后的书籍
        let currentBookSearch = ''; // 当前搜索关键词
        
        // 关键词筛选相关变量
        let selectedRandomKeywords = [];
        let filteredRandomSentences = [];
        let randomKeywordSearchResults = [];

        // 初始化随机模式
        function initializeRandomMode() {
            console.log('初始化随机模式...');
            loadRandomQuote();
            setupRandomModeEventListeners();
            updateRandomFilterStatus(); // 初始化筛选状态显示
        }

        // 设置随机模式事件监听器
        function setupRandomModeEventListeners() {
            // 换一换按钮
            document.getElementById('getNewRandomQuote').addEventListener('click', loadRandomQuote);
            
            // 自动播放按钮
            document.getElementById('autoPlayToggle').addEventListener('click', toggleAutoPlay);
            
            // 速度控制滑块
            document.getElementById('autoPlaySpeed').addEventListener('input', function(e) {
                autoPlaySpeed = parseFloat(e.target.value);
                document.getElementById('speedDisplay').textContent = autoPlaySpeed + '秒';
                
                // 如果正在自动播放，重新设置定时器以应用新速度
                if (isAutoPlaying) {
                    restartAutoPlayWithNewSpeed();
                }
            });
            
            // 复制按钮
            document.getElementById('copyRandomQuote').addEventListener('click', copyCurrentQuote);
            
            // 全屏按钮
            document.getElementById('enterFullscreen').addEventListener('click', enterFullscreenMode);
            
            // 清空历史按钮
            document.getElementById('clearHistory').addEventListener('click', clearQuoteHistory);
            
            // 关键词筛选相关事件
            document.getElementById('searchRandomKeywordsBtn').addEventListener('click', searchRandomKeywords);
            document.getElementById('getRandomFilteredSentencesBtn').addEventListener('click', applyRandomKeywordFilter);
            document.getElementById('clearRandomFilterBtn').addEventListener('click', clearRandomKeywordFilter);
            
            // 书籍选择相关事件
            document.getElementById('loadBooksBtn').addEventListener('click', loadBooksList);
            document.getElementById('selectAllBooksBtn').addEventListener('click', selectAllBooks);
            document.getElementById('clearBookSelectionBtn').addEventListener('click', clearBookSelection);
            
            // 书籍搜索相关事件
            document.getElementById('bookSearchInput').addEventListener('input', function(e) {
                searchBooks(e.target.value);
            });
            document.getElementById('clearBookSearchBtn').addEventListener('click', clearBookSearch);
            
            // 关键词输入框回车事件
            document.getElementById('randomKeywordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchRandomKeywords();
                }
            });
            
            // 随机模式标签页激活事件
            document.getElementById('random-tab').addEventListener('shown.bs.tab', function() {
                console.log('随机模式标签页被激活');
                if (randomQuotes.length === 0) {
                    loadRandomQuote();
                }
            });
        }

        // 加载随机句子
        function loadRandomQuote() {
            const loadingDiv = document.getElementById('randomQuoteLoading');
            const contentDiv = document.getElementById('randomQuoteContent');
            const copyBtn = document.getElementById('copyRandomQuote');
            
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            copyBtn.disabled = true;

            // 如果有选定的关键词，从筛选结果中随机选择
            if (selectedRandomKeywords.length > 0 && filteredRandomSentences.length > 0) {
                const randomSentence = filteredRandomSentences[Math.floor(Math.random() * filteredRandomSentences.length)];
                setTimeout(() => {
                    displayRandomQuote(randomSentence);
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                }, 200); // 添加短暂延迟以显示加载状态
                return;
            }

            // 否则请求新的随机句子
            const requestData = {};
            
            // 如果有选定的书籍，传递书籍列表
            if (selectedBooks.length > 0) {
                requestData.selected_books = selectedBooks;
            }
            
            fetch('/api/random_quote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayRandomQuote(data.quote);
                    updateRandomStats(data.stats);
                } else {
                    showToast('获取随机句子失败: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('获取随机句子错误:', error);
                showToast('网络错误，请重试', 'error');
            })
            .finally(() => {
                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
            });
        }

        // 显示随机句子
        function displayRandomQuote(quote) {
            currentRandomQuote = quote;
            randomSessionCount++;
            
            // 格式化句子：在标点符号后换行
            const formattedText = formatQuoteText(quote.content);
            
            // 更新显示
            document.getElementById('randomQuoteText').innerHTML = formattedText;
            document.getElementById('randomQuoteSource').textContent = quote.book_name;
            document.getElementById('copyRandomQuote').disabled = false;
            
            // 添加到历史记录
            addToQuoteHistory(quote);
            
            // 更新本次浏览计数
            document.getElementById('currentSessionCount').textContent = randomSessionCount;
        }

        // 格式化句子文本：在标点符号后换行，每行居中
        function formatQuoteText(text) {
            // 在标点符号后添加换行符，但保持标点符号在前一行
            // 顿号(、)不进行换行
            const formatted = text.replace(/([，。；！？：])/g, '$1<br>');
            
            // 分割成行，为每行添加居中样式
            const lines = formatted.split('<br>').filter(line => line.trim());
            
            const centeredLines = lines.map(line => 
                `<div style="text-align: center; margin: 5px 0;">${line.trim()}</div>`
            ).join('');
            
            return centeredLines;
        }

        // 更新随机模式统计
        function updateRandomStats(stats) {
            document.getElementById('totalQuotesCount').textContent = stats.total_sentences;
            document.getElementById('uniqueBooksCount').textContent = stats.unique_books;
        }

        // 复制当前句子
        function copyCurrentQuote() {
            if (!currentRandomQuote) {
                showToast('没有可复制的句子', 'warning');
                return;
            }
            
            const textToCopy = `${currentRandomQuote.content}\n\n—— 来源：${currentRandomQuote.book_name}`;
            copyToClipboard(textToCopy, 'copyRandomQuote', '句子已复制');
        }

        // 添加到历史记录
        function addToQuoteHistory(quote) {
            // 避免重复添加相同的句子
            const isDuplicate = recentQuotes.some(item => 
                item.content === quote.content && item.filename === quote.filename
            );
            
            if (!isDuplicate) {
                recentQuotes.unshift({
                    ...quote,
                    timestamp: new Date().toLocaleString()
                });
                
                // 限制历史记录数量
                if (recentQuotes.length > maxRecentQuotes) {
                    recentQuotes = recentQuotes.slice(0, maxRecentQuotes);
                }
                
                updateQuoteHistoryDisplay();
            }
        }

        // 更新历史记录显示
        function updateQuoteHistoryDisplay() {
            const container = document.getElementById('recentQuotesContainer');
            
            if (recentQuotes.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">还没有浏览记录</p>';
                return;
            }
            
            const historyHtml = recentQuotes.map((quote, index) => `
                <div class="recent-quote-item" onclick="selectHistoryQuote(${index})">
                    <div class="recent-quote-text">${quote.content}</div>
                    <div class="recent-quote-source">
                        <i class="bi bi-book"></i> ${quote.book_name} 
                        <small class="text-muted">• ${quote.timestamp}</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = historyHtml;
        }

        // 选择历史记录中的句子
        function selectHistoryQuote(index) {
            if (index >= 0 && index < recentQuotes.length) {
                const quote = recentQuotes[index];
                currentRandomQuote = quote;
                
                // 格式化并显示句子
                const formattedText = formatQuoteText(quote.content);
                document.getElementById('randomQuoteText').innerHTML = formattedText;
                document.getElementById('randomQuoteSource').textContent = quote.book_name;
                document.getElementById('copyRandomQuote').disabled = false;
                
                showToast('已重新加载该句子', 'success');
            }
        }

        // 清空历史记录
        function clearQuoteHistory() {
            recentQuotes = [];
            updateQuoteHistoryDisplay();
            showToast('历史记录已清空', 'success');
        }

        // 切换自动播放状态
        function toggleAutoPlay() {
            if (isAutoPlaying) {
                stopAutoPlay();
            } else {
                startAutoPlay();
            }
        }

        // 开始自动播放
        function startAutoPlay() {
            if (!currentRandomQuote) {
                loadRandomQuote();
            }
            
            isAutoPlaying = true;
            const button = document.getElementById('autoPlayToggle');
            button.innerHTML = '<i class="bi bi-pause-fill"></i> 暂停播放';
            button.className = 'btn btn-outline-warning btn-lg me-3';
            
            // 使用当前设置的速度
            autoPlayInterval = setInterval(() => {
                loadRandomQuote();
            }, autoPlaySpeed * 1000); // 转换为毫秒
            
            showToast(`自动播放已开启 (${autoPlaySpeed}秒间隔)`, 'success');
        }

        // 停止自动播放
        function stopAutoPlay() {
            isAutoPlaying = false;
            const button = document.getElementById('autoPlayToggle');
            button.innerHTML = '<i class="bi bi-play-fill"></i> 自动播放';
            button.className = 'btn btn-outline-success btn-lg me-3';
            
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
            }
            
            showToast('自动播放已停止', 'info');
        }

        // 重新启动自动播放以应用新速度
        function restartAutoPlayWithNewSpeed() {
            if (!isAutoPlaying) return;
            
            // 清除旧的定时器
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
            }
            
            // 判断是否在全屏模式
            const isFullscreen = document.getElementById('fullscreenOverlay').style.display === 'flex';
            
            // 使用新速度重新设置定时器
            autoPlayInterval = setInterval(() => {
                if (isFullscreen) {
                    loadRandomQuoteForFullscreen();
                } else {
                    loadRandomQuote();
                }
            }, autoPlaySpeed * 1000); // 转换为毫秒
            
            showToast(`播放速度已更新为 ${autoPlaySpeed}秒`, 'info');
        }

        // 设置播放速度的快捷函数
        function setSpeed(speed) {
            autoPlaySpeed = speed;
            document.getElementById('autoPlaySpeed').value = speed;
            document.getElementById('speedDisplay').textContent = speed + '秒';
            
            // 如果正在自动播放，重新设置定时器以应用新速度
            if (isAutoPlaying) {
                restartAutoPlayWithNewSpeed();
            }
        }

        // 进入全屏模式
        function enterFullscreenMode() {
            if (!currentRandomQuote) {
                showToast('请先获取一个随机句子', 'warning');
                return;
            }
            
            const overlay = document.getElementById('fullscreenOverlay');
            const fullscreenText = document.getElementById('fullscreenQuoteText');
            const fullscreenSource = document.getElementById('fullscreenQuoteSource');
            
            // 更新全屏显示内容
            updateFullscreenQuote();
            
            // 显示全屏覆盖层
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.classList.add('show');
                // 设置初始背景
                overlay.classList.add(`bg-gradient-${currentBackgroundIndex}`);
                // 在显示后调整字体大小
                adjustFullscreenFontSize();
            }, 10);
            
            // 添加键盘事件监听
            document.addEventListener('keydown', handleFullscreenKeydown);
            
            // 添加窗口大小变化监听
            window.addEventListener('resize', adjustFullscreenFontSize);
            
            // 阻止页面滚动
            document.body.style.overflow = 'hidden';
            
            // 如果自动播放正在进行，在全屏模式下继续
            if (isAutoPlaying) {
                // 清除原有的定时器
                if (autoPlayInterval) {
                    clearInterval(autoPlayInterval);
                }
                // 在全屏模式下重新设置定时器，使用当前速度
                autoPlayInterval = setInterval(() => {
                    loadRandomQuoteForFullscreen();
                }, autoPlaySpeed * 1000);
            }
        }

        // 退出全屏模式
        function exitFullscreenMode() {
            const overlay = document.getElementById('fullscreenOverlay');
            
            overlay.classList.remove('show');
            // 清理背景类
            for (let i = 1; i <= 6; i++) {
                overlay.classList.remove(`bg-gradient-${i}`);
            }
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
            
            // 移除事件监听
            document.removeEventListener('keydown', handleFullscreenKeydown);
            window.removeEventListener('resize', adjustFullscreenFontSize);
            
            // 恢复页面滚动
            document.body.style.overflow = '';
            
            // 如果自动播放正在进行，恢复正常模式的定时器
            if (isAutoPlaying) {
                // 清除全屏模式的定时器
                if (autoPlayInterval) {
                    clearInterval(autoPlayInterval);
                }
                // 重新设置正常模式的定时器，使用当前速度
                autoPlayInterval = setInterval(() => {
                    loadRandomQuote();
                }, autoPlaySpeed * 1000);
            }
            
            // 同步全屏模式的句子到原页面
            syncQuoteToMainPage();
        }

        // 同步句子到主页面显示
        function syncQuoteToMainPage() {
            if (!currentRandomQuote) return;
            
            // 更新主页面的句子显示
            const formattedText = formatQuoteText(currentRandomQuote.content);
            document.getElementById('randomQuoteText').innerHTML = formattedText;
            document.getElementById('randomQuoteSource').textContent = currentRandomQuote.book_name;
            document.getElementById('copyRandomQuote').disabled = false;
            
            // 更新本次浏览计数
            document.getElementById('currentSessionCount').textContent = randomSessionCount;
        }

        // 更新全屏模式的句子显示（带动画效果）
        function updateFullscreenQuote(withAnimation = false) {
            if (!currentRandomQuote) return;
            
            const fullscreenText = document.getElementById('fullscreenQuoteText');
            const fullscreenSource = document.getElementById('fullscreenQuoteSource');
            
            if (withAnimation) {
                // 添加淡出动画
                fullscreenText.classList.add('fade-out');
                fullscreenSource.classList.add('fade-out');
                
                setTimeout(() => {
                    // 更新内容
                    const formattedText = formatQuoteText(currentRandomQuote.content);
                    fullscreenText.innerHTML = formattedText;
                    fullscreenSource.textContent = `—— ${currentRandomQuote.book_name}`;
                    
                    // 同步切换背景（在文本更新的同时开始背景过渡）
                    changeFullscreenBackground();
                    
                    // 移除淡出类，添加淡入类
                    fullscreenText.classList.remove('fade-out');
                    fullscreenSource.classList.remove('fade-out');
                    fullscreenText.classList.add('fade-in');
                    fullscreenSource.classList.add('fade-in');
                    
                    // 调整字体大小
                    setTimeout(() => {
                        adjustFullscreenFontSize();
                    }, 50);
                    
                    // 清理动画类
                    setTimeout(() => {
                        fullscreenText.classList.remove('fade-in');
                        fullscreenSource.classList.remove('fade-in');
                    }, 600);
                    
                }, 600); // 等待淡出动画完成
            } else {
                // 无动画直接更新
                const formattedText = formatQuoteText(currentRandomQuote.content);
                fullscreenText.innerHTML = formattedText;
                fullscreenSource.textContent = `—— ${currentRandomQuote.book_name}`;
                
                // 调整字体大小以适应屏幕
                setTimeout(() => {
                    adjustFullscreenFontSize();
                }, 50);
            }
        }

        // 处理全屏模式的键盘事件
        function handleFullscreenKeydown(event) {
            switch(event.key) {
                case ' ':  // 空格键 - 下一句
                    event.preventDefault();
                    loadRandomQuoteForFullscreen();
                    break;
                case 'Escape':  // ESC键 - 退出全屏
                    event.preventDefault();
                    exitFullscreenMode();
                    break;
            }
        }

        // 为全屏模式加载新的随机句子
        function loadRandomQuoteForFullscreen() {
            // 如果有选定的关键词，从筛选结果中随机选择
            if (selectedRandomKeywords.length > 0 && filteredRandomSentences.length > 0) {
                const randomSentence = filteredRandomSentences[Math.floor(Math.random() * filteredRandomSentences.length)];
                currentRandomQuote = randomSentence;
                randomSessionCount++;
                
                // 更新全屏显示（带动画）
                updateFullscreenQuote(true);
                
                // 添加到历史记录
                addToQuoteHistory(randomSentence);
                return;
            }

            // 否则请求新的随机句子
            const requestData = {};
            
            // 如果有选定的书籍，传递书籍列表
            if (selectedBooks.length > 0) {
                requestData.selected_books = selectedBooks;
            }
            
            fetch('/api/random_quote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentRandomQuote = data.quote;
                    randomSessionCount++;
                    
                    // 更新全屏显示（带动画）
                    updateFullscreenQuote(true);
                    
                    // 添加到历史记录
                    addToQuoteHistory(data.quote);
                    
                    // 更新统计（如果需要的话）
                    updateRandomStats(data.stats);
                } else {
                    console.error('获取随机句子失败:', data.error);
                }
            })
            .catch(error => {
                console.error('获取随机句子错误:', error);
            });
        }

        // 自适应调整全屏模式字体大小
        function adjustFullscreenFontSize() {
            const fullscreenText = document.getElementById('fullscreenQuoteText');
            if (!fullscreenText) return;
            
            const container = fullscreenText.parentElement;
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            // 获取文本内容长度
            const textLength = fullscreenText.textContent.length;
            const textHeight = fullscreenText.scrollHeight;
            
            // 计算基础字体大小（基于视口和文本长度）
            let baseFontSize;
            
            // 根据文本长度调整基础大小
            if (textLength < 50) {
                baseFontSize = Math.min(viewportWidth * 0.05, viewportHeight * 0.07); // 短文本使用中等字体，避免过大
            } else if (textLength < 150) {
                baseFontSize = Math.min(viewportWidth * 0.05, viewportHeight * 0.07); // 中等文本
            } else if (textLength < 300) {
                baseFontSize = Math.min(viewportWidth * 0.04, viewportHeight * 0.06); // 长文本较小
            } else {
                baseFontSize = Math.min(viewportWidth * 0.03, viewportHeight * 0.04); // 很长文本最小
            }
            
            // 设置最小和最大字体大小
            const minFontSize = 24; // 最小24px
            const maxFontSize = Math.min(viewportWidth * 0.1, 120); // 最大120px或视口宽度的10%
            
            baseFontSize = Math.max(minFontSize, Math.min(maxFontSize, baseFontSize));
            
            // 应用字体大小
            fullscreenText.style.fontSize = baseFontSize + 'px';
            
            // 检查内容是否超出屏幕高度，如果超出则进一步缩小
            setTimeout(() => {
                const maxHeight = viewportHeight * 0.7; // 最大占用70%的屏幕高度
                let attempts = 0;
                
                while (fullscreenText.scrollHeight > maxHeight && attempts < 10) {
                    baseFontSize *= 0.9;
                    if (baseFontSize < minFontSize) break;
                    fullscreenText.style.fontSize = baseFontSize + 'px';
                    attempts++;
                }
                
                // 设置合适的行高
                const lineHeight = Math.max(1.4, Math.min(1.8, 1.6 - (textLength / 1000)));
                fullscreenText.style.lineHeight = lineHeight;
            }, 50);
        }

        // 切换全屏模式背景渐变
        function changeFullscreenBackground() {
            const overlay = document.getElementById('fullscreenOverlay');
            if (!overlay || !overlay.classList.contains('show')) return;
            
            // 移除当前背景类
            for (let i = 1; i <= 6; i++) {
                overlay.classList.remove(`bg-gradient-${i}`);
            }
            
            // 切换到下一个背景
            currentBackgroundIndex = (currentBackgroundIndex % 6) + 1;
            
            // 添加新的背景类
            overlay.classList.add(`bg-gradient-${currentBackgroundIndex}`);
        }

        // ==================== 关键词筛选功能 ====================
        
        // 搜索随机模式关键词
        function searchRandomKeywords() {
            const query = document.getElementById('randomKeywordInput').value.trim();
            if (!query) {
                showToast('请输入关键词', 'warning');
                return;
            }
            
            // 清除之前选择的关键词状态
            selectedRandomKeywords = [];
            updateRandomSelectedKeywordsDisplay();
            
            const searchBtn = document.getElementById('searchRandomKeywordsBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 搜索中...';
            
            // 调用关键词搜索API - 使用与关键词检索相同的参数格式
            fetch('/api/keyword_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    limit: 20
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.keywords && data.keywords.length > 0) {
                    displayRandomKeywordCandidates(data.keywords);
                } else {
                    showToast('未找到相关关键词', 'info');
                    hideRandomKeywordResults();
                }
            })
            .catch(error => {
                console.error('搜索关键词错误:', error);
                showToast('搜索失败，请重试', 'error');
            })
            .finally(() => {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="bi bi-search"></i> 搜索';
            });
        }
        
        // 显示候选关键词
        function displayRandomKeywordCandidates(keywords) {
            const resultsDiv = document.getElementById('randomKeywordResults');
            const listDiv = document.getElementById('randomKeywordList');
            
            listDiv.innerHTML = '';
            keywords.forEach(keyword => {
                const keywordSpan = document.createElement('span');
                keywordSpan.className = 'random-keyword-item';
                keywordSpan.textContent = `${keyword.keyword} (${keyword.count})`;
                keywordSpan.addEventListener('click', () => selectRandomKeyword(keyword));
                listDiv.appendChild(keywordSpan);
            });
            
            resultsDiv.style.display = 'block';
        }
        
        // 隐藏关键词搜索结果
        function hideRandomKeywordResults() {
            document.getElementById('randomKeywordResults').style.display = 'none';
        }
        
        // 选择关键词
        function selectRandomKeyword(keyword) {
            // 检查是否已选择
            if (selectedRandomKeywords.find(k => k.keyword === keyword.keyword)) {
                showToast('该关键词已选择', 'warning');
                return;
            }
            
            selectedRandomKeywords.push(keyword);
            updateRandomSelectedKeywordsDisplay();
            
            // 更新候选关键词显示状态
            updateRandomKeywordCandidatesDisplay();
        }
        
        // 更新已选关键词显示
        function updateRandomSelectedKeywordsDisplay() {
            const selectedDiv = document.getElementById('randomSelectedKeywords');
            const listDiv = document.getElementById('randomSelectedKeywordList');
            
            if (selectedRandomKeywords.length === 0) {
                selectedDiv.style.display = 'none';
                return;
            }
            
            selectedDiv.style.display = 'block';
            listDiv.innerHTML = '';
            
            selectedRandomKeywords.forEach(keyword => {
                const keywordSpan = document.createElement('span');
                keywordSpan.className = 'random-selected-keyword';
                keywordSpan.innerHTML = `
                    <span>${keyword.keyword} (${keyword.count})</span>
                    <button class="remove-btn" onclick="removeRandomSelectedKeyword('${keyword.keyword}')">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                listDiv.appendChild(keywordSpan);
            });
        }
        
        // 更新候选关键词显示状态
        function updateRandomKeywordCandidatesDisplay() {
            const candidates = document.querySelectorAll('#randomKeywordList .random-keyword-item');
            candidates.forEach(item => {
                const keywordText = item.textContent.split(' (')[0];
                const isSelected = selectedRandomKeywords.some(k => k.keyword === keywordText);
                item.classList.toggle('selected', isSelected);
            });
        }
        
        // 移除已选关键词
        function removeRandomSelectedKeyword(keyword) {
            const index = selectedRandomKeywords.findIndex(k => k.keyword === keyword);
            if (index > -1) {
                selectedRandomKeywords.splice(index, 1);
                updateRandomSelectedKeywordsDisplay();
                updateRandomKeywordCandidatesDisplay();
                
                // 如果没有选定关键词了，清空筛选状态
                if (selectedRandomKeywords.length === 0) {
                    filteredRandomSentences = [];
                    updateRandomFilterStatus();
                }
            }
        }
        
        // 应用关键词筛选
        function applyRandomKeywordFilter() {
            if (selectedRandomKeywords.length === 0) {
                showToast('请先选择关键词', 'warning');
                return;
            }
            
            const keywords = selectedRandomKeywords.map(k => k.keyword);
            
            fetch('/api/get_sentences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    keywords: keywords
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.sentences) {
                    filteredRandomSentences = data.sentences
                        .filter(sentence => sentence && typeof sentence === 'object') // 过滤掉null/undefined的句子
                        .map(sentence => {
                            // 安全处理filename，避免undefined或null导致的错误
                            const filename = sentence.filename || '';
                            const book_name = filename ? filename.replace('.txt', '').replace(/^《/, '').replace(/》$/, '') : '未知来源';
                            
                            return {
                                content: sentence.content || '',
                                filename: filename,
                                book_name: book_name
                            };
                        });
                    
                    updateRandomFilterStatus();
                    showToast(`筛选成功！共找到 ${filteredRandomSentences.length} 个相关句子`, 'success');
                    
                    // 隐藏候选关键词和已选关键词区域
                    hideRandomKeywordResults();
                    document.getElementById('randomSelectedKeywords').style.display = 'none';
                } else {
                    filteredRandomSentences = [];
                    showToast('未找到相关句子', 'warning');
                }
            })
            .catch(error => {
                console.error('获取筛选句子错误:', error);
                showToast('获取句子失败', 'error');
            });
        }
        
        // 更新筛选状态显示
        function updateRandomFilterStatus() {
            const statusDiv = document.getElementById('randomFilterStatus');
            const statusText = document.getElementById('randomFilterStatusText');
            
            if (filteredRandomSentences.length > 0) {
                statusDiv.className = 'alert alert-success';
                statusText.innerHTML = `<strong>已应用筛选</strong> - 从 ${filteredRandomSentences.length} 个包含关键词 "${selectedRandomKeywords.map(k => k.keyword).join(', ')}" 的句子中随机展示`;
            } else {
                statusDiv.className = 'alert alert-info';
                statusText.textContent = '未应用筛选，将从所有句子中随机展示';
            }
            
            statusDiv.style.display = 'block';
        }
        
        // 清空关键词筛选
        function clearRandomKeywordFilter() {
            selectedRandomKeywords = [];
            filteredRandomSentences = [];
            
            document.getElementById('randomKeywordInput').value = '';
            updateRandomSelectedKeywordsDisplay();
            hideRandomKeywordResults();
            updateRandomFilterStatus();
            
            showToast('关键词筛选已清空', 'success');
        }

        // ==================== 书籍选择功能 ====================
        
        // 加载书籍列表
        function loadBooksList() {
            const loadBtn = document.getElementById('loadBooksBtn');
            const originalText = loadBtn.innerHTML;
            
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 加载中...';
            
            fetch('/api/books', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('书籍API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('书籍API响应数据:', data);
                if (data.success && data.books) {
                    allBooks = data.books;
                    filteredBooks = [...data.books]; // 初始化筛选列表
                    displayBooksList(data.books);
                    updateBooksCount(data.books.length, data.books.length);
                    
                    // 显示相关UI元素
                    document.getElementById('bookSelectionArea').style.display = 'block';
                    document.getElementById('bookSearchArea').style.display = 'block';
                    document.getElementById('selectAllBooksBtn').style.display = 'inline-block';
                    document.getElementById('clearBookSelectionBtn').style.display = 'inline-block';
                    
                    let message = `成功加载 ${data.books.length} 本书籍`;
                    if (data.error_count && data.error_count > 0) {
                        message += `，${data.error_count} 个文件处理失败`;
                    }
                    showToast(message, 'success');
                } else {
                    const errorMsg = data.error || '未知错误';
                    console.error('API返回错误:', errorMsg);
                    showToast('加载书籍列表失败: ' + errorMsg, 'error');
                }
            })
            .catch(error => {
                console.error('加载书籍列表错误详情:', error);
                console.error('错误堆栈:', error.stack);
                showToast(`网络错误: ${error.message}`, 'error');
            })
            .finally(() => {
                loadBtn.disabled = false;
                loadBtn.innerHTML = originalText;
            });
        }
        
        // 显示书籍列表
        function displayBooksList(books) {
            const booksListDiv = document.getElementById('booksList');
            booksListDiv.innerHTML = '';
            
            books.forEach(book => {
                const colDiv = document.createElement('div');
                colDiv.className = 'col-md-6 col-lg-4 mb-2';
                
                const isSelected = selectedBooks.includes(book.name);
                
                colDiv.innerHTML = `
                    <div class="card book-card ${isSelected ? 'border-primary' : ''}" style="cursor: pointer;" onclick="toggleBookCheckbox('${book.name}')">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                <input type="checkbox" class="form-check-input me-2 mt-1" 
                                       ${isSelected ? 'checked' : ''} 
                                       onchange="toggleBookSelection('${book.name}', this.checked)"
                                       onclick="event.stopPropagation()">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-2" title="${book.name}">${book.name}</h6>
                                    <div class="book-info">
                                        <i class="bi bi-file-text"></i> ${((book.size || 0) / 1024).toFixed(1)}KB
                                        <span class="ms-2"><i class="bi bi-fonts"></i> ${(book.char_count || 0).toLocaleString()}字</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                booksListDiv.appendChild(colDiv);
            });
        }
        
        // 切换书籍选择状态
        function toggleBookSelection(bookName, isSelected) {
            if (isSelected) {
                if (!selectedBooks.includes(bookName)) {
                    selectedBooks.push(bookName);
                }
            } else {
                const index = selectedBooks.indexOf(bookName);
                if (index > -1) {
                    selectedBooks.splice(index, 1);
                }
            }
            
            updateSelectedBooksDisplay();
        }
        
        // 更新已选书籍显示
        function updateSelectedBooksDisplay() {
            const displayDiv = document.getElementById('selectedBooksDisplay');
            const listDiv = document.getElementById('selectedBooksList');
            const countSpan = document.getElementById('selectedBooksCount');
            
            if (selectedBooks.length > 0) {
                displayDiv.style.display = 'block';
                countSpan.textContent = selectedBooks.length;
                
                listDiv.innerHTML = '';
                selectedBooks.forEach(bookName => {
                    const badgeDiv = document.createElement('div');
                    badgeDiv.className = 'badge bg-primary';
                    badgeDiv.innerHTML = `
                        ${bookName}
                        <button type="button" class="btn-close btn-close-white ms-1" 
                                onclick="removeBookSelection('${bookName}')" 
                                style="font-size: 0.7em;"></button>
                    `;
                    listDiv.appendChild(badgeDiv);
                });
            } else {
                displayDiv.style.display = 'none';
            }
        }
        
        // 移除书籍选择
        function removeBookSelection(bookName) {
            const index = selectedBooks.indexOf(bookName);
            if (index > -1) {
                selectedBooks.splice(index, 1);
                updateSelectedBooksDisplay();
                
                // 更新列表中的复选框状态
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    if (checkbox.onchange && checkbox.onchange.toString().includes(bookName)) {
                        checkbox.checked = false;
                    }
                });
                
                // 重新显示书籍列表以更新状态
                if (filteredBooks.length > 0) {
                    displayBooksList(filteredBooks);
                }
            }
        }
        
        // 清空书籍选择
        function clearBookSelection() {
            selectedBooks = [];
            updateSelectedBooksDisplay();
            if (filteredBooks.length > 0) {
                displayBooksList(filteredBooks); // 重新显示以更新复选框状态
            }
            showToast('已清空书籍选择', 'success');
        }

        // ==================== 书籍搜索功能 ====================
        
        // 搜索书籍
        function searchBooks(searchTerm) {
            currentBookSearch = searchTerm.trim().toLowerCase();
            
            if (currentBookSearch === '') {
                // 清空搜索，显示所有书籍
                filteredBooks = [...allBooks];
                document.getElementById('bookFilterStatus').style.display = 'none';
            } else {
                // 按书名筛选
                filteredBooks = allBooks.filter(book => 
                    book.name.toLowerCase().includes(currentBookSearch)
                );
                document.getElementById('bookFilterStatus').style.display = 'inline';
            }
            
            displayBooksList(filteredBooks);
            updateBooksCount(filteredBooks.length, allBooks.length);
        }
        
        // 清空书籍搜索
        function clearBookSearch() {
            document.getElementById('bookSearchInput').value = '';
            searchBooks('');
        }
        
        // 更新书籍数量显示
        function updateBooksCount(displayed, total) {
            document.getElementById('displayedBooksCount').textContent = displayed;
            document.getElementById('totalBooksCount').textContent = total;
        }
        
        // 点击书籍卡片切换选择状态
        function toggleBookCheckbox(bookName) {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.onchange && checkbox.onchange.toString().includes(bookName)) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.onchange();
                    return;
                }
            });
        }
        
        // 修改全选书籍函数，只选择当前显示的书籍
        function selectAllBooks() {
            const booksToSelect = filteredBooks.map(book => book.name);
            
            // 合并选择，避免重复
            booksToSelect.forEach(bookName => {
                if (!selectedBooks.includes(bookName)) {
                    selectedBooks.push(bookName);
                }
            });
            
            updateSelectedBooksDisplay();
            displayBooksList(filteredBooks); // 重新显示以更新复选框状态
            
            let message = `已选择当前显示的 ${booksToSelect.length} 本书籍`;
            if (currentBookSearch) {
                message += ` (筛选结果)`;
            }
            showToast(message, 'success');
        }
    </script>
</body>
</html>
